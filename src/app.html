<div :class="{dark: theme === 'dark', preview}">
  <!-- Confirm model removal-->
  <md-dialog-confirm
    md-title="Remove"
    md-content-html="To delete current model or dataframe select <b>REMOVE</b><br>To cancel click anywhere outside of this white block or choose CANCEL"
    md-ok-text="Remove"
    md-cancel-text="Cancel"
    @close="removeModelConfirmed"
    ref="remove-dialog">
  </md-dialog-confirm>

  <!-- Confirm model removal-->
  <md-dialog-confirm
    md-title="Create new project"
    md-content-html="If you create a new project all existing models and data will be removed.<br>Click <b>NEW PROJECT</b> to remove all assets and start a new project"
    md-ok-text="New project"
    md-cancel-text="Cancel"
    @close="newProject"
    ref="new-project-dialog">
  </md-dialog-confirm>

  <!-- Create link dialog -->
  <md-dialog
    md-open-from="#generate-link"
    md-close-to="#generate-link"
    ref="generate-link-dialog"
    v-if="models && models.length"
  >
    <md-dialog-title>Generate link</md-dialog-title>
    <md-dialog-content>
      <md-checkbox v-model="linkParams.preview" class="md-primary">Preview mode</md-checkbox><br>
      <md-checkbox v-if="models.findIndex((m) => m.modelParams.type && (m.modelParams.type === 'dataframe')) >= 0" v-model="linkParams.includeDataframes" class="md-primary">Include dataframes</md-checkbox><br>
      <md-checkbox v-if="models.findIndex((m) => m.modelParams.type && (m.modelParams.type === 'dataframe') && (m.pipeline.source.type !== 'none')) >= 0" v-model="linkParams.sourcesOnly" class="md-primary">Include only data sources</md-checkbox><br>
      <md-checkbox v-if="models[activeModel].modelParams.type && (models[activeModel].modelParams.type === 'dataframe') && (models[activeModel].pipeline.source.type === 'url') && (models[activeModel].pipeline.source.url.length)" v-model="linkParams.dataUrl" class="md-primary">Make clean URL</md-checkbox>
    </md-dialog-content>
    <md-dialog-actions>
      <md-button class="md-primary" @click="closeDialog('generate-link-dialog')">Cancel</md-button>
      <md-button class="md-primary" @click="generateLink(); closeDialog('generate-link-dialog')">Create link</md-button>
    </md-dialog-actions>
  </md-dialog>

  <!-- Onboarding -->
  <md-dialog
    ref="onboarding"
  >
    <md-dialog-title>Hi. Welcome to StatSim!</md-dialog-title>
    <md-dialog-content>
      <b>It's easy to get started!</b> We initialized a new empty model for you.<br>
      If you want to load data or open existing project use buttons below.<br>
      Just close this message to start experimenting...
    </md-dialog-content>
    <md-dialog-actions>
      <md-button class="md-primary" @click="closeDialog('onboarding')">
        <md-icon style="opacity: 0.3">insert_drive_file</md-icon>
        New
      </md-button>
      <md-button class="md-primary" @click="openFile('Project')">
        <md-icon style="opacity: 0.3">unarchive</md-icon>
        Open
      </md-button>
      <md-button class="md-primary" @click="openFile('Data')">
        <md-icon style="opacity: 0.3">storage</md-icon>
        Load data
      </md-button>
    </md-dialog-actions>
  </md-dialog>

  <div class="icons" v-if="chooseIconForBlock >= 0">
    <div style="text-align: right;">
      <md-button class="md-icon-button" v-on:click.native="chooseIconForBlock = -1">
        <md-icon>close</md-icon>
      </md-button>
    </div>
    <md-button v-for="(icon, iconKey) in icons" v-on:click.native="chooseIcon(icon)" class="md-icon-button">
      <md-icon>{{ iconKey }}</md-icon>
    </md-button>
  </div>

  <md-toolbar class="tool-bar md-dense">
    <input type="file" accept=".csv, .tsv, .txt" id="openDataFile" v-on:change="openDataFile" style="display: none;" />
    <input type="file" accept=".json, .ssp" id="openProjectFile" v-on:change="openProjectFile" style="display: none;" />
    <md-menu md-align-trigger md-size="4" class="hamburger" @open="noScroll" @close="scroll">
      <md-button md-menu-trigger class="md-icon-button">
        <md-icon>menu</md-icon>
      </md-button>
      <md-menu-content>
        <md-menu-item v-on:selected="openDialog('new-project-dialog')">
          <md-icon style="">insert_drive_file</md-icon>
          <span>New project</span>
        </md-menu-item>
        <md-menu-item v-on:selected="openFile('Project')">
        <md-icon style="">unarchive</md-icon>
          <span>Open project</span>
        </md-menu-item>
        <md-menu-item v-on:selected="saveProject">
          <md-icon style="">archive</md-icon>
          <span>Save project</span>
        </md-menu-item>
        <md-menu-item v-on:selected="openFile('Data')" style="border-bottom: 1px solid #DDD">
          <md-icon style="">input</md-icon>
          <span>Import data</span>
        </md-menu-item>
        <md-menu-item v-if="!preview" v-on:selected="preview = true; showDataTable = false">
          <md-icon style="">visibility</md-icon>
          <span>Preview mode</span>
        </md-menu-item>
        <md-menu-item v-else="preview" v-on:selected="preview = false">
          <md-icon style="">edit</md-icon>
          <span>Editor mode</span>
        </md-menu-item>
        <md-menu-item v-if="theme === 'dark'" v-on:selected="setTheme('light')">
          <md-icon style="">brightness_5</md-icon>
          <span>Light theme</span>
        </md-menu-item>
        <md-menu-item v-else="theme === 'light'" v-on:selected="setTheme('dark')">
          <md-icon style="">brightness_2</md-icon>
          <span>Dark theme</span>
        </md-menu-item>
      </md-menu-content>
    </md-menu>
    <!-- <p class="logo-icon">{{ icon }}</p> -->
    <h2 class="md-title logo editor-only" style="flex: 1"> StatSim <sup class="version">{{ version }}</sup></h2>
    <md-menu
      md-align-trigger
      md-size="4"
      md-direction="bottom left"
      v-if="models && models.length && !(models[activeModel].modelParams.type && (models[activeModel].modelParams.type === 'dataframe'))"
      :class="'editor-only ' + ((models[activeModel].blocks.length || (models.length > 1)) ? '' : 'onboarding-menu')"
      @open="noScroll" @close="scroll"
    >
      <md-button class="md-raised md-primary add-block-button" md-menu-trigger>
        <md-icon>add</md-icon>
        Add block
      </md-button>
      <md-menu-content>
        <md-menu-item v-on:click.native="addBlock(2)">
          <md-icon :style="'color: ' + colors[2]">view_headline</md-icon>
          <span>Data (Input)</span>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(0)">
          <md-icon :style="'color: ' + colors[0]">graphic_eq</md-icon>
          <span>Random Variable</span>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(1)">
          <md-icon :style="'color: ' + colors[1]">functions</md-icon>
          <span>Expression</span>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(7)">
          <md-icon :style="'color: ' + colors[7]">show_chart</md-icon>
          <span>Function</span>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(3)">
          <md-icon :style="'color: ' + colors[3]">exposure_plus_1</md-icon>
          <span>Accumulator</span>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(6)">
          <md-icon :style="'color: ' + colors[6]">apps</md-icon>
          <span>Neural Net</span>
        </md-menu-item>
        <md-menu-item disabled>
          <small>Inference operators:</small>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(4)">
          <md-icon :style="'color: ' + colors[4]">visibility</md-icon>
          <span>Observer</span>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(5)">
          <md-icon :style="'color: ' + colors[5]">done_all</md-icon>
          <span>Condition</span>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(8)">
          <md-icon :style="'color: ' + colors[5]">import_export</md-icon>
          <span>Optimize</span>
        </md-menu-item>
      </md-menu-content>
    </md-menu>


  </md-toolbar>
  <div id="side-bar" v-if="models && models.length" class="side-bar editor-only">
    <!-- MODELS -->
    <div class="model-selector">
      <div
        class="model-button-container"
        v-for="(model, modelId) in models"
      >
        <md-button
          :class="{'md-dense': true, 'md-raised': (modelId === activeModel)}"
          v-on:click.native="switchModel(modelId)"
          :title="model.modelParams.name"
        >
          <span v-if="(modelId === activeModel) || models.length < 8">
            <span class="model-bullet" style="color: #3f51b5;" v-if="model.modelParams.type && (model.modelParams.type === 'dataframe')">&#9670;</span>
            <span class="model-bullet" style="color: #ddba00;" v-else-if="model.modelParams.type && (model.modelParams.type === 'tf')">&#9679;</span>
            <span class="model-bullet" style="color: #5db53b;" v-else>&#9679;</span>
          </span>
          <span v-if="(modelId === activeModel) || models.length < 4">{{ (model.modelParams.name.length > 9) ? model.modelParams.name.substring(0, 6) + "..." : model.modelParams.name }}</span>
        </md-button>
        <md-button class="model-close-button md-icon-button md-dense" v-on:click.native="removeModel(modelId)" :disabled="(models.length <= 1)">
          <md-icon style="opacity: 0.3">close</md-icon>
        </md-button>
      </div>
      <md-menu md-align-trigger md-size="4" md-direction="bottom right" @open="noScroll" @close="scroll">
        <md-button md-menu-trigger class="md-icon-button md-dense" style="background:none;">
          <md-icon style="opacity: 0.3">add</md-icon>
        </md-button>
        <md-menu-content>
          <md-menu-item v-on:selected="createModel()">
            <md-icon>add</md-icon>
            <span>New model</span>
          </md-menu-item>
          <!--
          <md-menu-item v-on:selected="createTFModel()">
            <md-icon>add</md-icon>
            <span>New TF model</span>
          </md-menu-item>
          -->
          <md-menu-item v-on:selected="createDataframe()">
            <md-icon>add</md-icon>
            <span>New dataframe</span>
          </md-menu-item>
        </md-menu-content>
      </md-menu>

    </div>
    <!-- MODEL INFO -->
    <div style="padding: 10px;">
      <md-input-container md-clearable>
        <label v-if="models[activeModel].modelParams.type && (models[activeModel].modelParams.type === 'dataframe')">Dataframe name</label>
        <label v-else>Model name</label>
        <md-input
          v-model="models[activeModel].modelParams.name"
        ></md-input>
      </md-input-container>
      <div>
        <textarea v-model="models[activeModel].modelParams.description" placeholder="Description..." rows="5"></textarea>
      </div>
      <div style="margin: 10px 0" v-if="(models.length > 1) && !(models[activeModel].modelParams.type && (models[activeModel].modelParams.type === 'dataframe'))">
        <label for="include">Include </label><br>
        <select
          name="include"
          id="include"
          v-model="models[activeModel].modelParams.include"
          multiple
          style="width:100%"
        >
          <option
            v-for="(m, mi) in models"
            v-if="mi !== activeModel"
            :value="mi"
            :key="mi"
          >{{ m.modelParams.name }}
          </option>
        </select>
      </div>
    </div>


    <!--
      Data processing
    <div class="phone-viewport">
      <md-toolbar md-theme="white">
      <span class="md-title">Preprocessing</span>
      </md-toolbar>
      <md-list>
      <md-list-item>
        <md-icon>whatshot</md-icon>
        <span>News</span>
        <md-list-expand>
        <md-list>
          <md-list-item class="md-inset">World</md-list-item>
          <md-list-item class="md-inset">Americas</md-list-item>
          <md-list-item class="md-inset">Europe</md-list-item>
        </md-list>
        </md-list-expand>
      </md-list-item>
      <md-list-item>
        <md-icon>videogame_asset</md-icon>
        <span>Games</span>
        <md-list-expand>
        <md-list>
          <md-list-item class="md-inset">Console</md-list-item>
          <md-list-item class="md-inset">PC</md-list-item>
          <md-list-item class="md-inset">Phone</md-list-item>
        </md-list>
        </md-list-expand>
      </md-list-item>
      <md-list-item>
        <md-icon>video_library</md-icon>
        <span>Video</span>
        <md-list-expand>
        <md-list>
          <md-list-item class="md-inset">Humor</md-list-item>
          <md-list-item class="md-inset">Movies</md-list-item>
          <md-list-item class="md-inset">TV Shows</md-list-item>
        </md-list>
        </md-list-expand>
      </md-list-item>
      <md-list-item>
        <md-icon>shopping_basket</md-icon>
        <span>Shop</span>
      </md-list-item>
      </md-list>
    </div>
    -->
    <!-- *Data processing -->


    <!-- Data processing -->
    <div class="data-tools" v-if="models[activeModel].modelParams.type && (models[activeModel].modelParams.type === 'dataframe')">
      <md-list>
        <md-list-item>
          <div style="width:100%">
            <md-input-container class="simulation-method-container">
              <label for="data-source">Load data from source:</label>
              <md-select name="data-source" id="data-source" v-model="models[activeModel].pipeline.source.type">
                <md-option value="none">None</md-option>
                <md-option value="file">File</md-option>
                <md-option value="url">URL</md-option>
                <md-option value="dataframe">Dataframe</md-option>
              </md-select>
            </md-input-container>
            <md-input-container v-if="models[activeModel].pipeline && models[activeModel].pipeline.source && models[activeModel].pipeline.source.type && (models[activeModel].pipeline.source.type === 'file')">
              <label>Select file:</label>
              <md-file placeholder="Select CSV file" @change.native="init($event.target.files, activeModel)" v-model="models[activeModel].pipeline.source.file"></md-file>
            </md-input-container>
            <md-input-container v-if="models[activeModel].pipeline && models[activeModel].pipeline.source && models[activeModel].pipeline.source.type && (models[activeModel].pipeline.source.type === 'url')">
               <label>Enter URL:</label>
               <md-input @blur.native="init(models[activeModel].pipeline.source.url, activeModel)" v-model="models[activeModel].pipeline.source.url"></md-input>
            </md-input-container>
            <md-input-container v-if="models[activeModel].pipeline && models[activeModel].pipeline.source && models[activeModel].pipeline.source.type && (models[activeModel].pipeline.source.type === 'dataframe')">
              <label>Select dataframe:</label>
              <md-select @change="preprocessDataframe(activeModel)" v-model="models[activeModel].pipeline.source.dataframe">
                <md-option v-for="(m, mi) in models" v-if="m.modelParams.type && (m.modelParams.type === 'dataframe')" :value="mi">{{m.modelParams.name}}</md-option>
              </md-select>
            </md-input-container>
            <div class="md-subhead" v-if="models[activeModel].pipeline && models[activeModel].pipeline.source && models[activeModel].pipeline.source.fileList">
              Source size: {{ (models[activeModel].pipeline.source.fileList[0].size / (1024 ** 2)).toFixed(2) }}Mb<br>
              <span v-if="models[activeModel].pipeline.source.fileList[0].lastModified">
                Modified: {{ (new Date(models[activeModel].pipeline.source.fileList[0].lastModified)).toUTCString() }}<br>
              </span>
            </div>
          </div>
        </md-list-item>

        <div v-if="(models[activeModel].pipeline.source.type !== 'none') && (models[activeModel].pipeline.source.file || models[activeModel].pipeline.source.url || (models[activeModel].pipeline.source.dataframe !== ''))">
          <!-- [ Parsing ] -->
          <md-list-item v-if="models[activeModel].pipeline && models[activeModel].pipeline.source && ((models[activeModel].pipeline.source.type == 'file') || (models[activeModel].pipeline.source.type == 'url'))">
            <md-icon>memory</md-icon>
            <span>Parse</span>
            <md-list-expand>
              <md-card>
                <md-card-content>
                  <md-input-container>
                    <label>Delimiter</label>
                    <md-input v-model="models[activeModel].pipeline.parse.delimiter"></md-input>
                  </md-input-container>
                  <md-input-container>
                    <label>Comment character</label>
                    <md-input v-model="models[activeModel].pipeline.parse.comment"></md-input>
                  </md-input-container>
                  <md-checkbox id="my-test2" name="my-test2" v-model="models[activeModel].pipeline.parse.hasHeader" @change="preprocessDataframe(activeModel)" class="md-primary">Has headers</md-checkbox>
                  <md-input-container>
                    <label>Custom header (comma-delimited)</label>
                    <md-input v-model="models[activeModel].pipeline.parse.customHeader" @blur.native="preprocessDataframe(activeModel)"></md-input>
                  </md-input-container>
                </md-card-content>
              </md-card>
            </md-list-expand>
          </md-list-item>

          <!-- [ Filters ]-->
          <md-list-item>
            <md-icon>filter_list</md-icon>
            <span>Filter</span>
            <md-list-expand>
              <md-card>
                <md-card-content>
                  <!-- (Add new filter) -->
                  <md-button v-on:click.native="addFilter(activeModel)">
                    <md-icon>add</md-icon>Add new filter
                  </md-button>
                  <!-- (Filter block) -->
                  <md-card class="item-card md-primary" v-for="(filter, i) in models[activeModel].pipeline.filters" :key="models[activeModel].modelParams.name + 'filter' + i">

                    <!-- Filter name and remove button -->
                    <md-card-header>
                      <md-card-header-text>
                        <div class="md-subhead"> {{ (filter.range) ?  'Range: ' + filter.from + ' -> ' + filter.to : 'Search: ' + filter.value }} </div>
                      </md-card-header-text>
                      <md-menu md-size="4" md-direction="bottom left" @open="noScroll" @close="scroll">
                        <md-button class="md-icon-button" md-menu-trigger>
                          <md-icon>more_vert</md-icon>
                        </md-button>
                        <md-menu-content>
                          <md-menu-item v-on:click.native="source.removeFilter(i)">
                            <span>Remove filter</span>
                            <md-icon>delete</md-icon>
                          </md-menu-item>
                        </md-menu-content>
                      </md-menu>
                    </md-card-header>

                    <!-- Filter params -->
                    <md-card-content>
                      <md-switch v-model="models[activeModel].pipeline.filters[i].range" class="md-warn">Range</md-switch>
                      <md-input-container v-if="!models[activeModel].pipeline.filters[i].range">
                        <label>Search string</label>
                        <md-input v-model="models[activeModel].pipeline.filters[i].value"></md-input>
                      </md-input-container>
                      <md-input-container v-if="models[activeModel].pipeline.filters[i].range">
                        <label>From: </label>
                        <md-input type="number" v-model="models[activeModel].pipeline.filters[i].from"></md-input>
                      </md-input-container>
                      <md-input-container v-if="models[activeModel].pipeline.filters[i].range">
                        <label>To: </label>
                        <md-input type="number" v-model="models[activeModel].pipeline.filters[i].to"></md-input>
                      </md-input-container>
                      <md-input-container>
                        <label for="search-column">Search in columns</label>
                        <md-select
                          name="search-column"
                          v-model="models[activeModel].pipeline.filters[i].column">
                          <md-option v-for="column in models[activeModel].pipeline.source.columns" :value="column" :key="column">{{ column }}</md-option>
                        </md-select>
                      </md-input-container>
                      <md-checkbox name="casesensitive" v-if="!models[activeModel].pipeline.filters[i].range" v-model="models[activeModel].pipeline.filters[i].casesensitive" class="md-primary">Case sensitive</md-checkbox>
                      <md-checkbox name="strict" v-if="!models[activeModel].pipeline.filters[i].range" v-model="models[activeModel].pipeline.filters[i].strict" class="md-primary">Strict search</md-checkbox>
                    </md-card-content>
                  </md-card> 
                  <!-- *Filter block-->
                </md-card-content>
              </md-card>
            </md-list-expand>
          </md-list-item>

          <md-list-item>
            <md-icon>device_hub</md-icon>
            <span>Structure</span>
            <md-list-expand>
              <md-card>
                <md-card-content>
                  <!-- Process all columns -->
                  <md-checkbox name="columns-showall" v-model="models[activeModel].pipeline.structure.showAll" class="md-primary">Keep all columns</md-checkbox>
                  <!-- OR select ones to keep -->
                  <div
                    v-if="!models[activeModel].pipeline.structure.showAll"
                    v-for="column in models[activeModel].pipeline.source.columns"
                  >
                    <input 
                      type="checkbox"
                      :id="column + i"
                      :name="column + i"
                      :value="column"
                      :key="column"
                      v-model="models[activeModel].pipeline.structure.columns"
                    />
                    <label :for="column + i">{{ column }}</label>
                  </div>
                </md-card-content>
              </md-card>
            </md-list-expand>
          </md-list-item>
          <md-list-item>
            <md-icon>file_download</md-icon>
            <span>Output</span>
            <md-list-expand>
              <md-card>
                <md-card-content>
                  <md-checkbox v-model="models[activeModel].pipeline.output.toMemory" class="md-primary">
                    Store output in memory
                  </md-checkbox><br>
                  <md-checkbox v-model="models[activeModel].pipeline.output.toStream" class="md-primary">
                    Stream to file (Chrome, Opera)
                  </md-checkbox>
                  <md-input-container v-if="models[activeModel].pipeline.output.toStream">
                    <label>Output format</label>
                    <md-select v-model="models[activeModel].pipeline.output.format">
                      <md-option value="csv">CSV</md-option>
                      <md-option value="xml">XML</md-option>
                      <md-option value="json">JSON</md-option>
                    </md-select>
                  </md-input-container>
                </md-card-content>
              </md-card>
            </md-list-expand>
          </md-list-item>
          <!--
          <md-list-item>
            <md-card>
              <md-card-content>
                <p>Processed: {{ models[activeModel].pipeline.processed }} </p>
                <p>Progress: {{ models[activeModel].pipeline.progress }} </p>
              </md-card-content>
            </md-card>
          </md-list-item>
          <md-list-item>
            <md-button class="md-raised md-primary" style="width: 100%; margin: 10px 0 0 0;" v-on:click.native="processDataframe(activeModel)">
              <md-icon style="color: white">arrow_downward</md-icon>
              Load
            </md-button>
          </md-list-item>
          -->
        </div> <!-- *data-source params -->
      </md-list>
    </div> <!-- *data-tools -->
    <!-- *Data processing -->

    <div style="text-align: center; opacity: 0.4" v-if="models[activeModel].blocks && models[activeModel].blocks.length">
      <md-button class="md-dense" @click="minimizeAllBlocks">
        <md-icon>remove</md-icon>
        Minimize
      </md-button>
      <md-button class="md-dense" @click="maximizeAllBlocks">
        <md-icon>fullscreen</md-icon>
        Maximize
      </md-button>
    </div>
    <!-- Add drag and drop -->
    <div
      class="block-container"
      v-for="(model, modelIndex) in models"
      v-if="!(model.modelParams.type && (model.modelParams.type === 'dataframe'))"
      :style="'display:' + ((modelIndex === activeModel) ? 'block' : 'none')"
    >
    <draggable
      v-model="model.blocks" :options="{handle: '.drag-handle'}"
    >
    <transition-group name="block-list">
    <!-- BLOCKS -->
    <md-card
      v-for="(block, blockIndex) in model.blocks"
      :key="block.id"
      :id="'block-id-' + modelIndex + '-' + blockIndex"
      :class="['block', 'block-' + block.typeCode, block.minimized ? 'block-minimized' : 'block-full']"
      :style="block.color ? 'border-top-color:' + block.color : ''"
    >
   <!-- Block actions bar-->
      <md-card-actions :class="'block-header block-header-' + block.typeCode">
        <div class="drag-handle">
          <div class="drag-handle-icon"></div>
        </div>
        <div class="block-name">
          <strong>{{ block.name }}</strong>
          <p class="block-type">{{ block.type }}</p>
            <!--
            <span v-if="block.minimized && block.value && block.value.length" style="font-weight:400">: {{ block.value.slice(0,15) }}...</span>
            <span v-if="block.minimized && block.distribution" style="font-weight:400">: {{ block.distribution }}...</span>
            -->
        </div>
        <md-button class="md-icon-button" v-if="block.minimized" v-on:click.native="toggle(blockIndex)">
          <md-icon>fullscreen</md-icon>
        </md-button>
        <md-button class="md-icon-button" v-if="!block.minimized" v-on:click.native="toggle(blockIndex)">
          <md-icon>remove</md-icon>
        </md-button>
        <md-button class="md-icon-button" v-on:click.native="moveBlockUp(blockIndex)">
          <md-icon>expand_less</md-icon>
        </md-button>
        <md-button class="md-icon-button" v-on:click.native="moveBlockDown(blockIndex)">
          <md-icon>expand_more</md-icon>
        </md-button>
        <md-menu md-align-trigger md-size="4" md-direction="bottom left" style="margin-right: 10px;" @open="noScroll" @close="scroll">
          <md-button md-menu-trigger class="md-icon-button md-dense">
            <md-icon>more_horiz</md-icon>
          </md-button>
          <md-menu-content>
            <md-menu-item v-on:selected="chooseIconForBlock = blockIndex" class="desktop">
              <md-icon>toys</md-icon>
              <span>Choose icon</span>
            </md-menu-item>
            <md-menu-item v-on:selected="moveBlockToTop(blockIndex)">
              <md-icon>keyboard_capslock</md-icon>
              <span>Move to top</span>
            </md-menu-item>
            <md-menu-item v-on:selected="cloneBlock(blockIndex)">
              <md-icon>flip_to_front</md-icon>
              <span>Clone block</span>
            </md-menu-item>
            <md-menu-item v-on:selected="removeBlock(blockIndex)">
              <md-icon>delete</md-icon>
              <span>Delete block</span>
            </md-menu-item>
          </md-menu-content>
        </md-menu>


      </md-card-actions>

      <!-- Random Variable -->
      <md-card-content v-if="(block.typeCode === 0) && !block.minimized">
        <md-input-container md-clearable>
          <label>Name</label>
          <md-input
            :value="block.name"
            @blur="set(block, 'name', $event)"
          ></md-input>
        </md-input-container>
        <md-input-container md-clearable>
          <label>Size / Dimensions</label>
          <md-input
            v-model="block.dims"
          ></md-input>
        </md-input-container>
        <md-whiteframe
          md-elevation="11"
          style="padding: 15px; margin: 5px 0 15px"
        >
          <md-input-container>
            <label for="distributionType">Distribution type:</label>
            <!-- @change: reset distribution paramaters when distribution changed -->
            <md-select
              name="distributionType"
              id="distributionType"
              v-model="block.distribution"
            >
              <md-option
                v-for="(params, distributionType) in distributions"
                v-if="distributionType !== models[activeModel].modelParams.name" 
                :value="distributionType"
                @selected="block.params = {}"
              >{{ distributionType }}</md-option>
            </md-select>
          </md-input-container>
          <md-input-container
            v-if="block.distribution.length" 
            v-for="(paramOptions, param) in distributions[block.distribution]"
            md-clearable
          >
            <label>{{ param }}</label>
            <md-input
              v-model="block.params[param]"
            ></md-input>
          </md-input-container>
        </md-whiteframe>

        <!-- Units -->
        <md-input-container>
         <label>Units</label>
          <md-autocomplete
            v-model="block.units"
            :list="units"
            :filter-list="unitsFilter"
            :min-chars="0"
            print-attribute="name"
          ></md-autocomplete>
        </md-input-container>

        <!-- Sample once per cycle-->
        <md-checkbox
          :disabled="(models[activeModel].modelParams.steps > 1.5) && !block.once"
          v-model="block.show"
          class="md-primary"
        >
          Show in output
        </md-checkbox>
        <md-checkbox
          v-model="block.once"
          :disabled="models[activeModel].modelParams.steps < 1.5"
          class="md-primary"
        >
          Sampled once
        </md-checkbox>
        <!-- <pre>{{ block }}</pre> -->
      </md-card-content>

      <!-- Expression -->
      <md-card-content v-if="(block.typeCode === 1) && !block.minimized">
        <md-input-container md-clearable>
          <label>Name</label>
          <md-input
            :value="block.name"
            @blur="set(block, 'name', $event)"
          ></md-input>
        </md-input-container>

        <!-- Expression type selector -->
        <md-whiteframe
          md-elevation="11"
          style="padding: 15px; margin: 5px 0 15px"
        >
          <md-input-container>
            <label for="expressionType">Expression template:</label>
            <!-- @change: reset distribution paramaters when distribution changed -->
            <md-select
              name="expressionType"
              id="expressionType"
              v-model="block.expressionType"
            >
              <md-option
                v-for="(params, expressionType) in expressions"
                :value="expressionType"
                @selected="block.params = {}"
              >{{ expressionType }}</md-option>
            </md-select>
          </md-input-container>

          <!--
            Use block.params to store values when special expression type is provided.
          -->
          <md-input-container
            v-if="block.expressionType.length && (block.expressionType !== 'Custom')" 
            v-for="param in expressions[block.expressionType]"
            md-clearable
          >
            <label style="text-transform: capitalize">{{ param }}</label>
            <md-input
              v-model="block.params[param]"
            ></md-input>
          </md-input-container>

          <!--
            Keep old expression working.
            Use block.value when Custom or type is not provided.
          -->
          <md-input-container v-if="(!block.expressionType) || (block.expressionType === 'Custom')">
            <label>Value</label>
            <md-input
              :value="block.value"
              @blur="set(block, 'value', $event)"
              :id="'input-' + blockIndex"
            ></md-input>
          </md-input-container>
        </md-whiteframe>

        <div class="data-input" style="display: flex">
          <!-- Units -->
          <md-input-container style="width: 95%; margin-right: 5%;">
            <label>Units</label>
            <md-autocomplete
              v-model="block.units"
              :list="units"
              :filter-list="unitsFilter"
              :min-chars="0"
              print-attribute="name"
            ></md-autocomplete>
            <md-button
              v-if="!block.expressionType || (block.expressionType === 'Custom')"
              class="md-icon-button md-dense"
              @click.native="guessUnits(block.value, blockIndex)"
            >
              <md-icon>loop</md-icon>
              <md-tooltip md-direction="bottom">Guess units</md-tooltip>
            </md-button>
          </md-input-container>
          <!-- Data type -->
          <md-input-container>
            <label for="dataType">Return type</label>
            <md-select
              name="dataType"
              id="dataType"
              v-model="block.dataType"
            >
              <md-option value="auto">Auto (default)</md-option>
              <md-option value="boolean">Boolean</md-option>
              <md-option value="integer">Integer</md-option>
              <md-option value="float">Float</md-option>
              <md-option value="string">String</md-option>
              <md-option value="array">Array</md-option>
              <md-option value="vector">Vector</md-option>
              <md-option value="tensor">Tensor</md-option>
            </md-select>
          </md-input-container>
        </div>

        <md-checkbox
          v-model="block.show"
          class="md-primary"
        >
          Show in output
        </md-checkbox>
        <md-checkbox 
          v-model="block.history"
          class="md-primary"
          :disabled="models[activeModel].modelParams.steps < 1.5"
        >
          Track history
        </md-checkbox>

      </md-card-content>

      <!-- Data -->
      <md-card-content v-if="(block.typeCode === 2) && !block.minimized">
        <md-input-container md-clearable>
          <label>Name</label>
          <md-input
            :value="block.name"
            @blur="set(block, 'name', $event)"
          ></md-input>
        </md-input-container>
        <div class="data-input">
          <md-input-container>
            <label>Value(s)</label>
            <!-- If table is active, redraw it on blur -->
            <md-textarea 
              v-if="block.dataType !== 'boolean'"
              height="5"
              :value="block.value"
              @blur="set(block, 'value', $event), reactiveDataTable && showDataTable && drawDataTable()"
            ></md-textarea>
            <md-select
              v-else
              v-model="block.value"
            >
              <md-option value="true">True</md-option>
              <md-option value="false">False</md-option>
            </md-select>
          </md-input-container>
          <md-button
            class="md-icon-button md-dense"
            v-if="block.dataType !== 'boolean'"
            @click.native="showDataTable = true; drawDataTable()"
          >
            <md-icon>grid_on</md-icon>
            <md-tooltip md-direction="bottom">Table view</md-tooltip>
          </md-button>
        </div>

        <div style="display: flex">
          <!-- Units -->
          <md-input-container style="width: 95%; margin-right: 5%;">
            <label>Units</label>
            <md-autocomplete
              v-model="block.units"
              :list="units"
              :filter-list="unitsFilter"
              :min-chars="0"
              print-attribute="name"
            ></md-autocomplete>
          </md-input-container>
          <!-- Data type -->
          <md-input-container>
            <label for="dataType">Data type</label>
            <md-select
              name="dataType"
              id="dataType"
              v-model="block.dataType"
            >
              <md-option value="auto">Auto (default)</md-option>
              <md-option value="proxy">Proxy</md-option>
              <md-option value="boolean">Boolean</md-option>
              <md-option value="integer">Integer</md-option>
              <md-option value="float">Float</md-option>
              <md-option value="string">String</md-option>
              <md-option value="category">Category</md-option>
              <md-option value="array">Array</md-option>
              <md-option value="vector">Vector</md-option>
              <md-option value="tensor">Tensor</md-option>
            </md-select>
          </md-input-container>
        </div>

        <!-- Tensor dimensions -->
        <md-input-container v-if="block.dataType === 'tensor'">
          <label>Tensor dimensions</label>
          <md-input v-model="block.dims"></md-input>
        </md-input-container>

        <!-- Categories -->
        <md-input-container v-if="block.dataType === 'category'">
          <label>Categories (comma-separated)</label>
          <md-input
            v-model="block.dataCategories"
          ></md-input>
        </md-input-container>


        <!-- Input? -->
        <md-checkbox
          v-model="block.useAsParameter"
          class="md-primary"
        >
          Use as model input
        </md-checkbox>

        <!-- Output? -->
        <md-checkbox
          v-model="block.show"
          class="md-primary"
        >
          Show in output
        </md-checkbox>

      </md-card-content>

      <!-- ** Function ** -->
      <md-card-content v-if="(block.typeCode === 7) && !block.minimized">
        <md-input-container md-clearable>
          <label>Name</label>
          <md-input
            :value="block.name"
            @blur="set(block, 'name', $event)"
          ></md-input>
        </md-input-container>
        <md-input-container md-clearable>
          <label v-if="block.tableFunction">X</label>
          <label v-else>Function parameters</label>
          <md-input
            :value="block.x"
            @blur="set(block, 'x', $event)"
          ></md-input>
        </md-input-container>

        <!-- Expression type selector -->
        <md-whiteframe
          v-if="!block.tableFunction"
          md-elevation="11"
          style="padding: 15px; margin: 5px 0 15px"
        >
          <md-input-container>
            <label for="expressionType">Function template:</label>
            <!-- @change: reset distribution paramaters when distribution changed -->
            <md-select
              name="expressionType"
              v-model="block.expressionType"
            >
              <md-option
                v-for="(params, expressionType) in expressions"
                :value="expressionType"
                @selected="block.params = {}"
              >{{ expressionType }}</md-option>
            </md-select>
          </md-input-container>

          <!--
            Use block.params to store values when special expression type is provided.
          -->
          <md-input-container
            v-if="block.expressionType.length && (block.expressionType !== 'Custom')" 
            v-for="param in expressions[block.expressionType]"
            md-clearable
          >
            <label style="text-transform: capitalize">{{ param }}</label>
            <md-input
              v-model="block.params[param]"
            ></md-input>
          </md-input-container>

          <!--
            Keep old expression working.
            Use block.value when Custom or type is not provided.
          -->
          <md-input-container v-if="(!block.expressionType) || (block.expressionType === 'Custom')">
            <label>Value</label>
            <md-input
              :value="block.y"
              @blur="set(block, 'y', $event)"
            ></md-input>
          </md-input-container>
        </md-whiteframe>

        <md-input-container v-if="block.tableFunction" md-clearable>
          <label>Y</label>
          <md-input
            :value="block.y"
            @blur="set(block, 'y', $event)"
          ></md-input>
        </md-input-container>
        <div style="display: flex" v-if="block.tableFunction">
          <md-input-container style="width: 95%; margin-right: 5%;">
            <label>Min</label>
            <md-input
              :value="block.min"
              @blur="set(block, 'min', $event)"
            ></md-input>
          </md-input-container>
          <md-input-container>
            <label>Max</label>
            <md-input
              :value="block.max"
              @blur="set(block, 'max', $event)"
            ></md-input>
          </md-input-container>
        </div>
        <div class="data-input" style="display: flex">
          <!-- Units -->
          <md-input-container style="width: 95%; margin-right: 5%;">
            <label>Units</label>
            <md-autocomplete
              v-model="block.units"
              :list="units"
              :filter-list="unitsFilter"
              :min-chars="0"
              print-attribute="name"
            ></md-autocomplete>
            <md-button
              v-if="!block.expressionType || (block.expressionType === 'Custom')"
              class="md-icon-button md-dense"
              @click.native="guessUnits(block.value, blockIndex)"
            >
              <md-icon>loop</md-icon>
              <md-tooltip md-direction="bottom">Guess units</md-tooltip>
            </md-button>
          </md-input-container>
          <!-- Data type -->
          <md-input-container>
            <label for="dataType">Return type</label>
            <md-select
              name="dataType"
              id="dataType"
              v-model="block.dataType"
            >
              <md-option value="auto">Auto (default)</md-option>
              <md-option value="boolean">Boolean</md-option>
              <md-option value="integer">Integer</md-option>
              <md-option value="float">Float</md-option>
              <md-option value="string">String</md-option>
              <md-option value="array">Array</md-option>
              <md-option value="vector">Vector</md-option>
              <md-option value="tensor">Tensor</md-option>
            </md-select>
          </md-input-container>
        </div>
        <md-checkbox v-model="block.tableFunction" class="md-primary">
          Table function
        </md-checkbox>
      </md-card-content>

      <!-- ** Accumulator ** -->
      <md-card-content v-if="(block.typeCode === 3) && !block.minimized">
        <md-input-container md-clearable>
          <label>Name</label>
          <md-input
            :value="block.name"
            @blur="set(block, 'name', $event)"
          ></md-input>
        </md-input-container>
        <md-input-container>
          <label>Change value/expression</label>
          <md-autocomplete
            v-model="block.value"
            :list="models[activeModel].blocks"
            :filter-list="blockFilter"
            :min-chars="0"
            :debounce="300"
            print-attribute="name"
            required
          ></md-autocomplete>
        </md-input-container>
        <md-input-container>
          <label>Initial value</label>
          <md-autocomplete
            v-model="block.initialValue"
            :list="models[activeModel].blocks"
            :filter-list="blockFilter"
            :min-chars="0"
            :debounce="300"
            print-attribute="name"
            required
          ></md-autocomplete>
        </md-input-container>
        <div style="display: flex">
          <md-input-container style="width: 95%; margin-right: 5%;">
            <label>Min</label>
            <md-input
              :value="block.min"
              @blur="set(block, 'min', $event)"
            ></md-input>
          </md-input-container>
          <md-input-container>
            <label>Max</label>
            <md-input
              :value="block.max"
              @blur="set(block, 'max', $event)"
            ></md-input>
          </md-input-container>
        </div>

        <!-- Units -->
        <md-input-container>
         <label>Units</label>
          <md-autocomplete
            v-model="block.units"
            :list="units"
            :filter-list="unitsFilter"
            :min-chars="0"
            print-attribute="name"
          ></md-autocomplete>
        </md-input-container>

        <md-checkbox v-model="block.show" class="md-primary">
          Show in output
        </md-checkbox>
        <md-checkbox 
          v-model="block.history"
          class="md-primary"
          :disabled="models[activeModel].modelParams.steps < 1.5"
        >
          Track history
        </md-checkbox>

      </md-card-content>

      <!-- ** Neural net ** -->
      <md-card-content v-if="(block.typeCode === 6) && !block.minimized">
        <md-input-container md-clearable>
          <label>Network name</label>
          <md-input
            :value="block.name"
            @blur="set(block, 'name', $event)"
          ></md-input>
        </md-input-container>
        <md-checkbox 
          v-model="block.convert"
          class="md-primary"
        >
          Convert tensors
        </md-checkbox>
        <md-whiteframe
          md-elevation="11"
          style="margin: 5px 0 15px"
        >
          <div class="layer"
            v-for="layer, layerIndex in block.layers"
          >
            <md-input-container>
              <label for="layerType">Layer type:</label>
              <md-select
                name="layerType"
                v-model="layer.type"
              >
                <md-option
                  v-for="type in ['affine', 'sigmoid', 'tanh', 'relu', 'softplus', 'softmax']"
                  :value="type"
                >{{ type[0].toUpperCase() + type.slice(1) }}</md-option>
              </md-select>
            </md-input-container>
            <md-input-container v-if="layer.type === 'affine'" md-clearable>
              <label>Layer name</label>
              <md-input
                v-model="layer.name"
              ></md-input>
            </md-input-container>
            <div style="display: flex" v-if="layer.type === 'affine'">
              <md-input-container style="width:40%; margin-right: 1%;">
                <label>In</label>
                <md-input
                  v-model="layer.in"
                ></md-input>
              </md-input-container>
              <md-icon style="color: rgba(150,150,150,0.4); auto 5px auto 5px;">chevron_right</md-icon>
              <md-input-container style="width: 40%;">
                <label>Out</label>
                <md-input
                  v-model="layer.out"
                ></md-input>
              </md-input-container>
            </div>
            <div class="layer-control">
            <md-button class="md-dense" v-on:click.native="block.layers.splice(layerIndex, 1)">
              Remove
            </md-button>
            </div>
          </div> <!-- *layer -->

        <md-button class="md-dense" style="width: 94%; margin: 10px 3%;" v-on:click.native="addLayer(blockIndex)">
          <md-icon>library_add</md-icon>
          Add new layer
        </md-button>
        </md-whiteframe>

      </md-card-content>


      <!-- ** Observer ** -->
      <md-card-content v-if="(block.typeCode === 4) && !block.minimized">
        <md-input-container>
          <label>Observed data</label>
          <md-autocomplete
            v-model="block.value"
            :list="models[activeModel].blocks"
            :filter-list="blockFilter"
            :min-chars="0"
            :debounce="300"
            print-attribute="name"
            required
          ></md-autocomplete>
        </md-input-container>
        <md-whiteframe
          md-elevation="11"
          style="padding: 15px; margin: 5px 0 15px"
          v-if="block.value.length"
        >
          <md-input-container>
            <label for="distributionType">Distribution:</label>
            <md-select
              name="distributionType"
              id="distributionType"
              v-model="block.distribution"
            >
              <md-option
                v-for="(params, distributionType) in distributions"
                :value="distributionType"
                @selected="block.params = {}"
              >{{ distributionType }}</md-option>
            </md-select>
          </md-input-container>
          <md-input-container
            v-if="block.distribution.length" 
            v-for="(paramOptions, param) in distributions[block.distribution]"
            md-clearable
          >
            <label>{{ param }}</label>
            <md-input
              v-model="block.params[param]"
            ></md-input>
          </md-input-container>
          <p style="font-size: 12px; color: 999;">
            In case of vectors you can get index as <b>_j</b><br>
            Dimension-wise indexes for tensors are <b>_j0, _j1, ...</b><br>
            Values stored in <b>_v</b>
          </p>
        </md-whiteframe>
        <!-- Custom loop parameters -->
        <div style="display: flex" v-if="block.customLoop">
          <md-input-container style="width: 95%; margin-right: 5%;">
            <label>Loop start</label>
            <md-input
              :value="block.loopStart"
              @blur="set(block, 'loopStart', $event)"
            ></md-input>
          </md-input-container>
          <md-input-container>
            <label>Loop end</label>
            <md-input
              :value="block.loopEnd"
              @blur="set(block, 'loopEnd', $event)"
            ></md-input>
          </md-input-container>
        </div>

        <md-checkbox 
          v-model="block.customLoop"
          class="md-primary"
        >
          Custom loop
        </md-checkbox>
      </md-card-content>

      <!-- Condition -->
      <md-card-content v-if="(block.typeCode === 5) && !block.minimized">
        <md-input-container>
          <label>Proposition expression (boolean)</label>
          <md-input
            :value="block.value"
            @blur="set(block, 'value', $event)"
          ></md-input>
        </md-input-container>
      </md-card-content>

      <!-- Optimize -->
      <md-card-content v-if="(block.typeCode === 8) && !block.minimized">
        <md-input-container>
          <label>Optimization target</label>
          <md-input
            :value="block.value"
            @blur="set(block, 'value', $event)"
          ></md-input>
        </md-input-container>
        <md-input-container>
          <label for="optimizationType">Type:</label>
          <md-select
            name="optimizationType"
            id="optimizationType"
            v-model="block.optimizationType"
          >
            <md-option value="minimize">Minimize</md-option>
            <md-option value="maximize">Maximize</md-option>
          </md-select>
        </md-input-container>
      </md-card-content>

      <md-card-expand v-if="block.icon && block.icon.length" class="desktop">
        <md-card-actions>
          <md-button disabled>Icon settings</md-button>
          <span style="flex: 1"></span>
          <md-button class="md-icon-button" md-expand-trigger>
            <md-icon>keyboard_arrow_down</md-icon>
          </md-button>
        </md-card-actions>
        <md-card-content>
          <md-input-container>
            <label>Size</label>
            <md-input
              v-model.number="block.size"
              type="number"
            ></md-input>
          </md-input-container>

          <color-picker 
            :value="block.color"
            @input="block.color = $event.hex"
          />
        </md-card-content>
      </md-card-expand>

    </md-card>
    </transition-group>
    </draggable>
    </div>

    <div style="padding: 10px;" v-if="!(models[activeModel].modelParams.type && (models[activeModel].modelParams.type === 'dataframe'))">
      <!-- Custom code block-->
      <textarea v-model="models[activeModel].modelParams.customCode" placeholder="Custom code..." rows="5"></textarea>

      <!-- Time steps-->
      <md-input-container class="simulation-param desktop">
        <label for="time-steps">Time steps (iterations)</label>
        <md-input
          name="time-steps"
          v-model="models[activeModel].modelParams.steps"
        >
        </md-input>
      </md-input-container>

      <!-- Time start-->
      <md-input-container class="simulation-param" v-if="models[activeModel].modelParams.steps.length && (models[activeModel].modelParams.steps !== '1')">
        <label for="time-steps">Time start</label>
        <md-input
          name="time-start"
          v-model="models[activeModel].modelParams.start"
        >
        </md-input>
      </md-input-container>


    </div>

    <!-- Model output -->
    <div class="block" v-if="!(models[activeModel].modelParams.type && (models[activeModel].modelParams.type === 'dataframe'))">
      <h3 v-if="models[activeModel].blocks.length > 0" style="margin: 35px 0 0 0">Model output:</h3>
      <md-checkbox v-for="block in models[activeModel].blocks" v-if="block.hasOwnProperty('show')" v-model="block.show" class="md-primary" style="width: 100%; margin: 10px 0 5px 0;">
        <strong>{{ block.name }}</strong> ({{ block.type }})
      </md-checkbox>
    </div>

    <!-- Empty model button -->
    <md-boards v-if="models[activeModel].blocks && !(models[activeModel].modelParams.customCode && models[activeModel].modelParams.customCode.length) && !models[activeModel].blocks.reduce((a, b) => b.show || a, false) && !(models[activeModel].modelParams.type && (models[activeModel].modelParams.type === 'dataframe'))" :md-controls="true" :md-infinite="true" :md-swipeable="true" style="height: auto !important; margin-bottom: 10px;">
      <md-board id="slide1">
        <p><b><span style="border: 1px solid #5db53b; background-color: #5db53b; color: white; padding: 3px 4px;">&nbsp;Add blocks&nbsp;</span> to your model.</b> After you open StatSim or create a new model, add some elements (blocks) to it. There are multiple types of blocks. Data blocks can be constants or input parameters, expressions set relationships between elements, random variables describe stochastic values.</p>
      </md-board>
      <md-board id="slide2">
        <p><b>Update blocks.</b> Each block has its own parameters. They determine how the program evaluates a block and its future usage. Almost each block has the <i>Show in results</i> checkbox. It determines if the block is shown in the output.</p>
      </md-board>
      <md-board id="slide3">
        <p><b>Set simulation <span style="border: 1px solid white; background-color: white; color: black; padding: 3px 4px;">Settings</span>.</b> After you created and set all the blocks it's time to choose a simulation method. The simple rule is if you don't use random variables select <i>Deterministic</i>. For simulations choose <i>Rejection Sampling</i> or <i>MCMC</i>, for ML select <i>Optimization</i>. </p>
      </md-board>
      <md-board id="slide4">
        <p><b><span style="border: 1px solid #3f51b5; background-color: #3f51b5; color: white; padding: 3px 4px;">&nbsp;Run&nbsp;</span> your model</b> after saving it. If you don't use a server for simulations StatSim may become unresponsive and you may lose your data. In case everything went right you get some informative charts or scalar values as a result. Compile your model to binaries if you want to use it as a separate app.</p>
      </md-board>
    </md-boards>

    <!-- Totem -->
    <div class="stat-seal" style="text-align: center;">
      <img src="images/s.png" style="width: 110px; height: auto; opacity: 0.3; margin: 15px 0px 20px 0"></img>
    </div>

    <!-- Model control -->
    <div style="text-align: center;">
      <md-button v-on:click.native="duplicateModel()">
        <md-icon>flip_to_front</md-icon>
        Duplicate
      </md-button>
      <md-button v-on:click.native="removeModel(activeModel)" :disabled="(models.length <= 1)" class="md-accent">
        <md-icon>close</md-icon>
        Remove <span>{{ (models[activeModel].modelParams.type && (models[activeModel].modelParams.type === 'dataframe')) ? 'data' : 'model' }}</span>
      </md-button>
    </div>
  </div>

  <!-- MODEL BAR -->
  <md-toolbar id="model-bar" class="model-bar message-bar md-dense md-transparent">
    <div style="flex: 1" v-if="models.length > 1">
      <md-button class="md-icon-button md-raised desktop" v-on:click.native="previousModel">
        <md-icon>arrow_back</md-icon>
      </md-button><md-button class="md-icon-button md-raised" v-on:click.native="nextModel">
        <md-icon>arrow_forward</md-icon>
      </md-button>
    </div>
    <!--
    <md-menu md-align-trigger md-size="4">
      <md-button class="md-icon-button md-raised" md-menu-trigger>
        <md-icon>multiline_chart</md-icon>
      </md-button>
      <md-menu-content>
        <md-menu-item v-on:selected="generateTFJS">
          <md-icon>insert_chart</md-icon>
          <span>Histogram</span>
        </md-menu-item>
        <md-menu-item v-on:selected="generateWebPPL">
          <md-icon>show_chart</md-icon>
          <span>Line chart</span>
        </md-menu-item>
        <md-menu-item v-on:selected="generatePYMC3">
          <md-icon>bubble_chart</md-icon>
          <span>Plot</span>
        </md-menu-item>
        <md-menu-item v-on:selected="generateJSON">
          <md-icon>pie_chart</md-icon>
          <span>Pie chart</span>
        </md-menu-item>
      </md-menu-content>
    </md-menu>
    -->
    <md-menu md-align-trigger md-size="4" @open="noScroll" @close="scroll" v-if="!(models[activeModel].modelParams.type && (models[activeModel].modelParams.type === 'dataframe'))">
      <md-button class="md-icon-button md-raised" md-menu-trigger>
        <md-icon>code</md-icon>
      </md-button>
      <md-menu-content>
        <md-menu-item v-on:selected="generateTFJS" v-if="models && models.length && models[activeModel].type && (models[activeModel].type === 'tf')">
          <span>TFJS</span>
        </md-menu-item>
        <md-menu-item v-on:selected="generateWebPPL">
          <span>WPPL</span>
        </md-menu-item>
        <md-menu-item v-on:selected="generateZ3">
          <span>Z3</span>
        </md-menu-item>
        <md-menu-item v-on:selected="generatePYMC3">
          <span>PYMC3</span>
        </md-menu-item>
        <md-menu-item v-on:selected="generateJSON">
          <span>JSON</span>
        </md-menu-item>
      </md-menu-content>
    </md-menu>
    <md-button id="generate-link" class="md-icon-button md-raised" v-on:click.native="openDialog('generate-link-dialog')">
      <md-icon>link</md-icon>
      <md-tooltip md-direction="bottom">Generate link</md-tooltip>
    </md-button>
    <md-button
      class="md-icon-button md-raised editor-only"
      v-if="models.length && !models[activeModel].modelParams.table"
      @click.native="enableDataTable"
    >
      <md-icon>grid_on</md-icon>
      <md-tooltip md-direction="bottom">Enable table</md-tooltip>
    </md-button>
    <md-button
      class="md-icon-button md-raised editor-only"
      v-if="models.length && models[activeModel].modelParams.table"
      @click.native="disableDataTable"
    >
      <md-icon>grid_off</md-icon>
      <md-tooltip md-direction="bottom">Disable table</md-tooltip>
    </md-button>

    <!-- Preview mode -->
    <md-button
      class="md-icon-button md-raised"
      v-if="!preview"
      @click.native="previewMode(true)"
    >
      <md-icon>visibility</md-icon>
      <md-tooltip md-direction="bottom">Preview mode</md-tooltip>
    </md-button>

    <md-button
      class="md-icon-button md-raised"
      v-else="preview"
      @click.native="previewMode(false)"
    >
      <md-icon>edit</md-icon>
      <md-tooltip md-direction="bottom">Edit mode</md-tooltip>
    </md-button>

    <!-- Model params -->
    <md-button class="md-icon-button md-raised" @click="toggleRightSidenav">
      <md-icon>tune</md-icon>
      <md-tooltip md-direction="bottom">Model parameters</md-tooltip>
    </md-button>

  </md-toolbar>

  <!-- CONTENT -->
  <div class="content">
    <!-- Generated links and code -->
    <div class="links wl" v-if="link.length">
      <div class="control-buttons">
        <md-button class="md-dense" @click.native="downloadCode">
          <md-icon>save</md-icon>
          <span class="desktop">Download</span>
        </md-button>
        <md-button class="md-dense" @click.native="copyCode">
          <md-icon>inbox</md-icon>
          <span class="desktop">Copy to clipboard</span>
        </md-button>
        <md-button class="md-dense" @click.native="link = ''">
          <md-icon>close</md-icon>
          <span class="desktop">Close</span>
        </md-button>
      </div>
      <pre id="link">{{ link }}</pre>
    </div>

    <!-- TABLE -->
    <div id="table-container" class="tables wl" v-if="models.length && models[activeModel].modelParams.table">
      <!--<div class="control-buttons" v-if="false && !(models[activeModel].modelParams.type && (models[activeModel].modelParams.type === 'dataframe'))">-->
      <div class="control-buttons" v-if="!preview">
        <md-button class="md-dense" @click.native="renderDataTable">
          <md-icon>refresh</md-icon>
          Reload
        </md-button>
        <md-button class="md-dense" @click.native="disableDataTable">
          <md-icon>close</md-icon>
          Close
        </md-button>
      </div>
      <div class="table-wrapper"></div>
      <div id="table-gradient" class="table-gradient" v-if="models[activeModel].preview">
        <h4>Preloaded data</h4>
        <p>Only 50 rows loaded. Click "Load" to read all data from the file</p>
      </div>
    </div>

    <!-- Needed for graph -->
    <div v-if="models && models.length && !(models[activeModel].modelParams.type && (models[activeModel].modelParams.type === 'dataframe'))" style="position: relative" class="graph-container">
      <div class="wl">
        <network
          class="net"
          ref="network"
          :nodes="graphNodes"
          :edges="graphLinks"
          :options="networkOptions"
          :events="['selectNode']"
          @select-node="selectNode"
        ></network>
        <!--
        <d3-network
          class="net"
          :net-nodes="graphNodes"
          :net-links="graphLinks"
          :options="graphOptions"
          :link-cb="lcb"
          v-on:node-click="ncb"
          v-if="graphNodes.length"
          ></d3-network>
        -->
        <!-- Model parameters input -->
        <div class="parameters">
          <div class="chips">
            <md-chip v-for="b in models[activeModel].blocks" :style="{background: colors[b.typeCode]}">{{ b.name || b.type }}</md-chip>
          </div>
          <p style="font-size:11px;">Model:</p>
          <h2>{{ models[activeModel].modelParams.name }}</h2>
          <p class="model-description">{{ models[activeModel].modelParams.description }}</p>
          <md-input-container v-for="b in models[activeModel].blocks" v-if="b.typeCode === 2 && b.useAsParameter">
            <label>{{ b.name + ((b.units && b.units.length) ? ', ' + b.units : '') }}</label>
            <!-- True/False -->
            <md-select
              v-if="b.dataType === 'boolean'"
              v-model="b.value"
            >
              <md-option value="true">True</md-option>
              <md-option value="false">False</md-option>
            </md-select>
            <!-- Categorical -->
            <md-select
              v-else-if="b.dataType === 'category'"
              v-model="b.value"
            >
              <md-option v-for="c in b.dataCategories ? b.dataCategories.split(',').map(cat => cat.trim()) : ['']" :value="c" >{{ c }}</md-option>
            </md-select>
            <!-- Proxy -->
            <md-select
              v-else-if="b.dataType === 'proxy'"
              v-model="b.value"
            >
              <div v-for="mod in models.filter(m => (m.modelParams.type && (m.modelParams.type === 'dataframe')))" v-if="mod.data">
                <md-option v-for="c in mod.data[0].filter(c => c).reduce((a, c) => a.concat(c), [])" :value="mod.modelParams.name + '.' + c" >{{ mod.modelParams.name + '.' + c }}</md-option>
              </div>
            </md-select>
            <!-- Regular input -->
            <md-input
              v-model="b.value"
              v-else
              :type="(b.dataType === 'float' || b.dataType === 'integer') ? 'number' : ''"
              :step="(b.dataType === 'integer') ? 1 : 0.1"
            ></md-input>
          </md-input-container>
        </div>
      </div>
    </div>
    <div class="charts wl"></div>
    <div class="charts-2d wl"></div>
    <div class="charts-extra wl"></div>
    <div class="archives wl"></div>
    <md-button
      v-if="Object.keys(samples).length > 0"
      v-on:click.native="download()"
      style="margin-left: 20px;"
    >
      <md-icon>save_alt</md-icon>
      Download (CSV)
    </md-button>

  </div>

  <!-- PARAMETERS BAR -->
  <md-sidenav v-if="models && models.length" class="param-bar md-right editor-only" ref="rightSidenav">
    <md-toolbar class="md-dense">
      <div class="md-toolbar-container">
        <h3 class="md-title" style="flex: 1">Project settings</h3>
        <md-button class="md-icon-button" @click="closeRightSidenav">
          <md-icon>close</md-icon>
        </md-button>
      </div>
    </md-toolbar>
    <div style="padding: 10px">

      <!-- Simulation method -->
      <md-input-container class="simulation-method-container">
        <label for="simulation-method">Simulation method:</label>
        <md-select name="simulation-method" id="simulation-method" v-model="models[activeModel].modelParams.method">
          <md-option
            v-for="(methodObj, method) in simulationMethods" 
            :value="method">{{ methodObj.name }}</md-option>
        </md-select>
      </md-input-container>
      <small>
        * - available in WebPPL only<br>
        ** - available in PyMC3 only (server-side)
      </small>

      <!-- Number of chains -->
      <md-input-container
        v-if="(models[activeModel].modelParams.method !== 'deterministic')"
      >
        <label>Number of chains/workers</label>
        <md-input
          type="number"
          step="1"
          v-model="models[activeModel].methodParams.chains"
        ></md-input>
      </md-input-container>


      <!-- Method parameters -->
      <div
        class="method-param"
        v-for="(paramOptions, param) in simulationMethods[models[activeModel].modelParams.method].params"
      >

      <!-- Boolean -->
      <md-checkbox 
        :name="param"
        v-model="models[activeModel].methodParams[param]"
        v-if="paramOptions.type === 'boolean'"
        class="md-primary"
      >{{ param }}</md-checkbox>

      <!-- Select / Number-->
      <md-input-container v-else>
          <label :for="param">{{ param }}</label>
          <md-input
            v-if="(paramOptions.type === 'int') || (paramOptions.type === 'real')"
            type="number"
            :step="(paramOptions.type === 'int') ? 1 : 0.001"
            v-model="models[activeModel].methodParams[param]"
          ></md-input>
          <md-select
            :name="param"
            v-if="paramOptions.type === 'select'"
            v-model="models[activeModel].methodParams[param]"
          >
            <md-option
              v-for="paramSelectValue in paramOptions.values"
              :value="paramSelectValue"
            >{{ paramSelectValue}}</md-option>
          </md-select>
        </md-input-container>

      </div>

      <md-checkbox 
        name="server"
        v-model="server"
        class="md-primary"
      >Server-side simulation</md-checkbox>

      <md-checkbox 
        name="server"
        v-model="serverCompile"
        class="md-primary"
        :disabled="!server"
      >Compile to binaries</md-checkbox>

      <!-- Server URL -->
      <md-input-container class="simulation-param">
        <label for="serverURL">URL</label>
        <md-input
          name="serverUrl"
          v-model="serverURL"
          :disabled="!server"
        >
        </md-input>
      </md-input-container>

      <!-- Server API -->
      <md-input-container class="simulation-param">
        <label for="serverAPI">API Key</label>
        <md-input
          name="serverAPI"
          v-model="serverAPI"
          :disabled="!server"
        >
        </md-input>
      </md-input-container>
      <!--
      <md-button class="md-raised md-primary" v-on:click.native="run()"><span class="desktop">Compile & </span>Run</md-button>
      -->
    </div>
  </md-sidenav>

  <!-- BOTTOM BAR-->
  <md-progress class="progress" v-if="loading" md-indeterminate></md-progress>
  <!-- DATAFRAME CONTROLS-->
  <md-bottom-bar v-if="models && models.length && models[activeModel].modelParams.type && (models[activeModel].modelParams.type === 'dataframe')" class="bottom-bar">
    <div class="model-summary">
      <p><b>Processed:</b> {{ (models[activeModel].pipeline.processed/ (1024 ** 2)).toFixed(2) }}Mb </p>
      <p><b>Progress:</b> {{ models[activeModel].pipeline.progress }}% </p>
    </div>
    <md-button v-if="!models[activeModel].loading" class="run-button md-raised md-primary" v-on:click.native="processDataframe(activeModel)">
      <md-icon>play_arrow</md-icon>
      Load & process
    </md-button>
    <md-button v-if="models[activeModel].loading" v-on:click.native="stopStream(activeModel)" class="md-raised md-accent control-button"><md-icon>stop</md-icon> Stop</md-button>
  </md-bottom-bar>
    <!-- MODEL CONTROLS-->
  <md-bottom-bar v-if="models && models.length && !(models[activeModel].modelParams.type && (models[activeModel].modelParams.type === 'dataframe'))" class="bottom-bar">
    <!-- Simulation method -->
    <md-input-container class="simulation-method-container simulation-param desktop editor-only">
      <label for="simulation-method">Simulation method</label>
      <md-select name="simulation-method" id="simulation-method" v-model="models[activeModel].modelParams.method">
        <md-option
          v-for="(methodObj, method) in simulationMethods" 
          :value="method">{{ methodObj.name }}</md-option>
      </md-select>
    </md-input-container>

    <div class="model-summary mobile">
      <p>Method: {{ models[activeModel].modelParams.method }}</p>
      <p>Time steps: {{ models[activeModel].modelParams.steps }}</p>
      <p v-if="(['MCMC','rejection', 'HMC'].indexOf(models[activeModel].modelParams.method) >= 0) &&  models[activeModel].methodParams.samples">Samples: {{ models[activeModel].methodParams.samples }}</p>
    </div>
    <md-button class="md-raised params-button editor-only" @click="toggleRightSidenav">
      <md-icon>tune</md-icon>
      <span class="desktop">Settings</span>
    </md-button>
    <md-button class="run-button md-raised md-primary" v-on:click.native="run()">
      <md-icon>play_arrow</md-icon>
      <span class="desktop editor-only">Compile & </span>Run
    </md-button>
  </md-bottom-bar>

  <!-- Loader -->
  <div id="loader" class="hidden"><span><md-icon>hourglass_empty</md-icon> Processing..</span></div>

  <!-- Notification / Snackbar -->
  <md-snackbar md-position="bottom center" ref="snackbar" md-duration="10000">
    <span>{{ notifyMessage }}</span>
    <md-button class="md-accent" md-theme="light-blue" @click.native="$refs.snackbar.close()">Close</md-button>
  </md-snackbar>

</div>
