<div :class="{dark: theme === 'dark', preview}">
  <!-- Confirm model removal-->
  <md-dialog-confirm
    md-title="Remove model?"
    md-content-html="To delete current model with all its elements select <b>REMOVE</b><br>To cancel click anywhere outside of this white block or choose CANCEL"
    md-ok-text="Remove"
    md-cancel-text="Cancel"
    @close="removeModel"
    ref="remove-dialog">
  </md-dialog-confirm>

  <md-toolbar class="tool-bar md-dense">
    <input type="file" accept=".csv, .tsv, .txt" id="openDataFile" v-on:change="openDataFile" style="display: none;" />
    <input type="file" accept=".json, .ssp" id="openProjectFile" v-on:change="openProjectFile" style="display: none;" />
    <md-menu md-align-trigger md-size="4">
      <md-button md-menu-trigger class="md-icon-button">
        <md-icon>menu</md-icon>
      </md-button>
      <md-menu-content>
        <md-menu-item v-on:selected="newProject">
          <md-icon style="">insert_drive_file</md-icon>
          <span>New project</span>
        </md-menu-item>
        <md-menu-item v-on:selected="openFile('Project')">
        <md-icon style="">unarchive</md-icon>
          <span>Open project</span>
        </md-menu-item>
        <md-menu-item v-on:selected="saveProject">
          <md-icon style="">archive</md-icon>
          <span>Save project</span>
        </md-menu-item>
        <md-menu-item v-on:selected="openFile('Data')" style="border-bottom: 1px solid #DDD">
          <md-icon style="">border_outer</md-icon>
          <span>Import data</span>
        </md-menu-item>
        <md-menu-item v-if="!preview" v-on:selected="preview = true; showDataTable = false">
          <md-icon style="">visibility</md-icon>
          <span>Preview mode</span>
        </md-menu-item>
        <md-menu-item v-else="preview" v-on:selected="preview = false">
          <md-icon style="">edit</md-icon>
          <span>Editor mode</span>
        </md-menu-item>        <md-menu-item v-if="theme === 'dark'" v-on:selected="setTheme('light')">
          <md-icon style="">brightness_5</md-icon>
          <span>Light theme</span>
        </md-menu-item>
        <md-menu-item v-else="theme === 'light'" v-on:selected="setTheme('dark')">
          <md-icon style="">brightness_2</md-icon>
          <span>Dark theme</span>
        </md-menu-item>
      </md-menu-content>
    </md-menu>
    <!-- <p class="logo-icon">{{ icon }}</p> -->
    <h2 class="md-title logo editor-only" style="flex: 1"> StatSim <sup class="version">0.9.0</sup></h2>
    <md-menu md-align-trigger md-size="4" md-direction="bottom left" class="editor-only">
      <md-button class="md-raised md-primary add-block-button" md-menu-trigger>
        <md-icon>add</md-icon>
        Add Block
        <md-tooltip md-direction="bottom">Add new element to the model</md-tooltip>
      </md-button>
      <md-menu-content>
        <md-menu-item v-on:click.native="addBlock(2)">
          <md-icon :style="'color: ' + colors[2]">view_headline</md-icon>
          <span>Data (Input)</span>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(0)">
          <md-icon :style="'color: ' + colors[0]">graphic_eq</md-icon>
          <span>Random Variable</span>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(1)">
          <md-icon :style="'color: ' + colors[1]">functions</md-icon>
          <span>Expression</span>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(3)">
          <md-icon :style="'color: ' + colors[3]">exposure_plus_1</md-icon>
          <span>Accumulator</span>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(6)">
          <md-icon :style="'color: ' + colors[6]">apps</md-icon>
          <span>Neural Net</span>
        </md-menu-item>
        <md-menu-item disabled>
          <small>Inference operators:</small>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(4)">
          <md-icon :style="'color: ' + colors[4]">visibility</md-icon>
          <span>Observer</span>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(5)">
          <md-icon :style="'color: ' + colors[5]">done_all</md-icon>
          <span>Condition</span>
        </md-menu-item>
        <!--
        <md-menu-item v-on:click.native="addBlock(6)">
          <md-icon :style="'color: ' + colors[5]">offline_bolt</md-icon>
          <span>Factor</span>
        </md-menu-item>
        -->
      </md-menu-content>
    </md-menu>


  </md-toolbar>
  <div id="side-bar" class="side-bar editor-only">
    <!-- MODELS -->
    <div class="model-selector">
      <md-button
        v-for="(model, modelId) in models"
        :class="{'md-dense': true, 'md-raised': (modelId === activeModel)}"
        v-on:click.native="switchModel(modelId)"
      >{{ model.modelParams.name }}
      </md-button>
      <md-menu md-align-trigger md-size="4" md-direction="bottom left" style="float: right">
        <md-button md-menu-trigger class="md-icon-button md-dense">
          <md-icon style="opacity: 0.3">more_horiz</md-icon>
        </md-button>
        <md-menu-content>
          <md-menu-item v-on:selected="createModel()">
            <md-icon>add</md-icon>
            <span>Add new model</span>
          </md-menu-item>
        </md-menu-content>
      </md-menu>

    </div>
    <!-- MODEL INFO -->
    <div style="padding: 10px;">
    <md-input-container md-clearable>
      <label>Model name</label>
      <md-input
        v-model="modelParams.name"
      ></md-input>
    </md-input-container>
    <div>
      <textarea v-model="modelParams.description" placeholder="Description..." rows="5"></textarea>
    </div>
    </div>
    <!-- BLOCKS -->
    <md-card 
      v-for="(block, blockIndex) in blocks"
      :id="'block-id-' + blockIndex"
      :class="'block block-' + block.typeCode"
    >
      <!-- Block actions bar-->
      <md-card-actions :class="'block-header-' + block.typeCode">
        <div class="block-name">
          <strong>{{ block.name }}</strong>
          <p class="block-type">{{ block.type }}</p>
        </div>
        <md-button class="md-icon-button" v-on:click.native="moveBlockUp(blockIndex)">
          <md-icon>expand_less</md-icon>
          <md-tooltip md-direction="bottom">Move up</md-tooltip>
        </md-button>
        <md-button class="md-icon-button" v-on:click.native="moveBlockDown(blockIndex)">
          <md-icon>expand_more</md-icon>
          <md-tooltip md-direction="bottom">Move down</md-tooltip>
        </md-button>
        <md-menu md-align-trigger md-size="4" md-direction="bottom left" style="margin-right: 10px;">
          <md-button md-menu-trigger class="md-icon-button md-dense">
            <md-icon>more_horiz</md-icon>
          </md-button>
          <md-menu-content>
            <md-menu-item v-on:selected="moveBlockToTop(blockIndex)">
              <md-icon>keyboard_capslock</md-icon>
              <span>Move to top</span>
            </md-menu-item>
            <md-menu-item v-on:selected="removeBlock(blockIndex)">
              <md-icon>delete</md-icon>
              <span>Delete block</span>
            </md-menu-item>
          </md-menu-content>
        </md-menu>


      </md-card-actions>

      <!-- Random Variable -->
      <md-card-content v-if="block.typeCode === 0">
        <md-input-container md-clearable>
          <label>Name</label>
          <md-input
            v-model="block.name"
          ></md-input>
        </md-input-container>
        <md-input-container md-clearable>
          <label>Size / Dimensions</label>
          <md-input
            v-model="block.dims"
          ></md-input>
        </md-input-container>
        <md-whiteframe
          md-elevation="11"
          style="padding: 15px; margin: 5px 0 15px"
        >
          <md-input-container>
            <label for="distributionType">Distribution type:</label>
            <!-- @change: reset distribution paramaters when distribution changed -->
            <md-select
              name="distributionType"
              id="distributionType"
              v-model="block.distribution"
            >
              <md-option
                v-for="(params, distributionType) in distributions"
                v-if="distributionType !== modelParams.name" 
                :value="distributionType"
                @selected="block.params = {}"
              >{{ distributionType }}</md-option>
            </md-select>
          </md-input-container>
          <md-input-container
            v-if="block.distribution.length" 
            v-for="(paramOptions, param) in distributions[block.distribution]"
            md-clearable
          >
            <label>{{ param }}</label>
            <md-input
              v-model="block.params[param]"
            ></md-input>
          </md-input-container>
        </md-whiteframe>

        <!-- Units -->
        <md-input-container>
         <label>Units</label>
          <md-autocomplete
            v-model="block.units"
            :list="units"
            :filter-list="unitsFilter"
            :min-chars="0"
            print-attribute="name"
          ></md-autocomplete>
        </md-input-container>

        <!-- Sample once per cycle-->
        <md-checkbox
          :disabled="(modelParams.steps > 1.5) && !block.once"
          v-model="block.show"
          class="md-primary"
        >
          Show in output
        </md-checkbox>
        <md-checkbox
          v-model="block.once"
          :disabled="modelParams.steps < 1.5"
          class="md-primary"
        >
          Sampled once
        </md-checkbox>
        <!-- <pre>{{ block }}</pre> -->
      </md-card-content>

      <!-- Expression -->
      <md-card-content v-if="block.typeCode === 1">
        <md-input-container md-clearable>
          <label>Name</label>
          <md-input
            v-model="block.name"
          ></md-input>
        </md-input-container>
        <md-input-container>
          <label>Value</label>
          <md-input
            v-model="block.value"
            :id="'input-' + blockIndex"
          ></md-input>
        </md-input-container>
        <!-- exp -->
        <md-tabs class="md-transparent">
          <md-tab md-label="Base">
            <md-button
              v-for="b, bi in blocks"
              v-if="([0, 1, 2].indexOf(b.typeCode) >= 0) && (bi !== blockIndex)"
              @click.native="addExpression(b.name, blockIndex, 1)"
            >{{ b.name }}</md-button>
            <hr>
            <md-button
              v-for="n in [0,1,2,3,4,5,6,7,8,9]"
              @click.native="addExpression(n + '', blockIndex, 0)"
            >{{ n }}</md-button>
            <md-button @click.native="addExpression('.', blockIndex, 0)">.</md-button>
          </md-tab>
          <md-tab md-label="Math">
            <md-button @click.native="addExpression('+', blockIndex, 0)">+</md-button>
            <md-button @click.native="addExpression('-', blockIndex, 0)">-</md-button>
            <md-button @click.native="addExpression('*', blockIndex, 0)">*</md-button>
            <md-button @click.native="addExpression('/', blockIndex, 0)">/</md-button>
            <md-button @click.native="addExpression('Math.sqrt()', blockIndex, -1)">x<sup>2</sup></md-button>
            <md-button @click.native="addExpression('Math.pow(,)', blockIndex, -2)">x<sup>y</sup></md-button>
            <md-button @click.native="addExpression('Math.PI', blockIndex, 1)">&#960;</md-button>
            <md-button @click.native="addExpression('Math.E', blockIndex, 1)">e</md-button>
          </md-tab>
          <md-tab md-label="Arrays">
            <md-button @click.native="addExpression('sum()', blockIndex, -1)">sum</md-button>
            <md-button @click.native="addExpression('product()', blockIndex, -1)">product</md-button>
            <md-button @click.native="addExpression('listMean()', blockIndex, -1)">mean</md-button>
            <md-button @click.native="addExpression('listVar()', blockIndex, -1)">var</md-button>
            <md-button @click.native="addExpression('listStdev()', blockIndex, -1)">std</md-button>
            <md-button @click.native="addExpression('all()', blockIndex, -1)">all</md-button>
            <md-button @click.native="addExpression('any()', blockIndex, -1)">any</md-button>
            <md-button @click.native="addExpression('filter(function(x) {},)', blockIndex, -2)">filter</md-button>
            <md-button @click.native="addExpression('find(function(x) {},)', blockIndex, -2)">find</md-button>
            <md-button @click.native="addExpression('remove(,)', blockIndex, -2)">remove</md-button>
            <md-button @click.native="addExpression('sort()', blockIndex, -1)">sort</md-button>
            <md-button @click.native="addExpression('map(function(x) {},)', blockIndex, -2)">map</md-button>
            <md-button @click.native="addExpression('map2(function(x,y) {},,)', blockIndex, -3)">map2</md-button>
            <md-button @click.native="addExpression('mapN(function(x) {},)', blockIndex, -3)">mapN</md-button>
            <md-button @click.native="addExpression('reduce(function(x, acc) {},,)', blockIndex, -3)">reduce</md-button>
          </md-tab>
          <md-tab md-label="Tensors">
            <md-button @click.native="addExpression('T.sumreduce()', blockIndex, -1)">sum</md-button>
            <md-button @click.native="addExpression('T.get(,)', blockIndex, -2)">get</md-button>
            <md-button @click.native="addExpression('T.toScalars()', blockIndex, -1)">toScalars</md-button>
            <md-button @click.native="addExpression('T.fromScalars()', blockIndex, -1)">fromScalars</md-button>
            <md-button @click.native="addExpression('T.transpose()', blockIndex, -1)">transpose</md-button>
            <md-button @click.native="addExpression('T.diagonal()', blockIndex, -1)">diagonal</md-button>
            <md-button @click.native="addExpression('T.inverse()', blockIndex, -1)">inverse</md-button>
            <md-button @click.native="addExpression('T.determinant()', blockIndex, -1)">determinant</md-button>
            <md-button @click.native="addExpression('T.dot(,)', blockIndex, -2)">dot</md-button>
            <md-button @click.native="addExpression('T.cholesky()', blockIndex, -1)">cholesky</md-button>
          </md-tab>
        </md-tabs>
	<!-- *exp -->

        <!-- Units -->
        <div class="data-input">
          <md-input-container>
           <label>Units</label>
            <md-autocomplete
              v-model="block.units"
              :list="units"
              :filter-list="unitsFilter"
              :min-chars="0"
              print-attribute="name"
            ></md-autocomplete>
            <md-button
              class="md-icon-button md-dense"
              @click.native="guessUnits(block.value, blockIndex)"
            >
              <md-icon>loop</md-icon>
              <md-tooltip md-direction="bottom">Guess units</md-tooltip>
            </md-button>
          </md-input-container>
        </div>

        <md-checkbox
          v-model="block.show"
          class="md-primary"
        >
          Show in output
        </md-checkbox>
        <md-checkbox 
          v-model="block.history"
          class="md-primary"
          :disabled="modelParams.steps < 1.5"
        >
          Track history
        </md-checkbox>

      </md-card-content>

      <!-- Data -->
      <md-card-content v-if="block.typeCode === 2">
        <md-input-container md-clearable>
          <label>Name</label>
          <md-input
            v-model="block.name"
          ></md-input>
        </md-input-container>
        <div class="data-input">
          <md-input-container>
            <label>Comma-separated values</label>
            <!-- If table is active, redraw it on blur -->
            <md-textarea v-model="block.value" height="5" @blur="reactiveDataTable && showDataTable && drawDataTable()"></md-textarea>
          </md-input-container>
          <md-button class="md-icon-button md-dense" @click.native="showDataTable = true; drawDataTable()">
            <md-icon>grid_on</md-icon>
            <md-tooltip md-direction="bottom">Table view</md-tooltip>
          </md-button>
        </div>
        <md-input-container v-if="block.value.indexOf(',') >= 0">
          <label>Dimensions (Tensor)</label>
          <md-input v-model="block.dims"></md-input>
        </md-input-container>

        <!-- Units -->
        <md-input-container>
         <label>Units</label>
          <md-autocomplete
            v-model="block.units"
            :list="units"
            :filter-list="unitsFilter"
            :min-chars="0"
            print-attribute="name"
          ></md-autocomplete>
        </md-input-container>

        <!-- Input? -->
        <md-checkbox
          v-model="block.useAsParameter"
          class="md-primary"
        >
          Use as model input
        </md-checkbox>

        <!-- Output? -->
        <md-checkbox
          v-model="block.show"
          class="md-primary"
        >
          Show in output
        </md-checkbox>

      </md-card-content>

      <!-- Accumulator -->
      <md-card-content v-if="block.typeCode === 3">
        <md-input-container md-clearable>
          <label>Name</label>
          <md-input
            v-model="block.name"
          ></md-input>
        </md-input-container>
        <md-input-container>
          <label>Change value/expression</label>
          <md-autocomplete
            v-model="block.value"
            :list="blocks"
            :filter-list="blockFilter"
            :min-chars="0"
            :debounce="300"
            print-attribute="name"
            required
          ></md-autocomplete>
        </md-input-container>
        <md-input-container>
          <label>Initial value</label>
          <md-autocomplete
            v-model="block.initialValue"
            :list="blocks"
            :filter-list="blockFilter"
            :min-chars="0"
            :debounce="300"
            print-attribute="name"
            required
          ></md-autocomplete>
        </md-input-container>
        <div style="display: flex">
          <md-input-container style="width: 40%; margin-right: 5%;">
            <label>Min</label>
            <md-input
              v-model="block.min"
            ></md-input>
          </md-input-container>
          <md-input-container style="width: 40%">
            <label>Max</label>
            <md-input
              v-model="block.max"
            ></md-input>
          </md-input-container>
        </div>

        <!-- Units -->
        <md-input-container>
         <label>Units</label>
          <md-autocomplete
            v-model="block.units"
            :list="units"
            :filter-list="unitsFilter"
            :min-chars="0"
            print-attribute="name"
          ></md-autocomplete>
        </md-input-container>

        <md-checkbox v-model="block.show" class="md-primary">
          Show in output
        </md-checkbox>
        <md-checkbox 
          v-model="block.history"
          class="md-primary"
          :disabled="modelParams.steps < 1.5"
        >
          Track history
        </md-checkbox>

      </md-card-content>

      <!-- Neural net -->
      <md-card-content v-if="block.typeCode === 6">
        <md-input-container md-clearable>
          <label>Network name</label>
          <md-input
            v-model="block.name"
          ></md-input>
        </md-input-container>
        <md-checkbox 
          v-model="block.convert"
          class="md-primary"
        >
          Convert tensors
        </md-checkbox>
        <md-whiteframe
          md-elevation="11"
          style="margin: 5px 0 15px"
        >
          <div class="layer"
            v-for="layer, layerIndex in block.layers"
          >
            <md-input-container>
              <label for="layerType">Layer type:</label>
              <md-select
                name="layerType"
                v-model="layer.type"
              >
                <md-option
                  v-for="type in ['affine', 'sigmoid', 'tanh', 'relu', 'softplus', 'softmax']"
                  :value="type"
                >{{ type[0].toUpperCase() + type.slice(1) }}</md-option>
              </md-select>
            </md-input-container>
            <md-input-container v-if="layer.type === 'affine'" md-clearable>
              <label>Layer name</label>
              <md-input
                v-model="layer.name"
              ></md-input>
            </md-input-container>
            <div style="display: flex" v-if="layer.type === 'affine'">
              <md-input-container style="width:40%; margin-right: 1%;">
                <label>In</label>
                <md-input
                  v-model="layer.in"
                ></md-input>
              </md-input-container>
              <md-icon style="color: rgba(150,150,150,0.4); auto 5px auto 5px;">chevron_right</md-icon>
              <md-input-container style="width: 40%;">
                <label>Out</label>
                <md-input
                  v-model="layer.out"
                ></md-input>
              </md-input-container>
            </div>
            <div class="layer-control">
            <md-button class="md-dense" v-on:click.native="block.layers.splice(layerIndex, 1)">
              Remove
            </md-button>
            </div>
          </div> <!-- *layer -->

        <md-button class="md-dense" style="width: 94%; margin: 10px 3%;" v-on:click.native="addLayer(blockIndex)">
          <md-icon>library_add</md-icon>
          Add new layer
        </md-button>
        </md-whiteframe>

      </md-card-content>


      <!-- Observer -->
      <md-card-content v-if="block.typeCode === 4">
        <md-input-container>
          <label>Observed data (scalar, vector or tensor)</label>
          <md-autocomplete
            v-model="block.value"
            :list="blocks"
            :filter-list="blockFilter"
            :min-chars="0"
            :debounce="300"
            print-attribute="name"
            required
          ></md-autocomplete>
        </md-input-container>
        <md-whiteframe
          md-elevation="11"
          style="padding: 15px; margin: 5px 0 15px"
          v-if="block.value.length"
        >
          <md-input-container>
            <label for="distributionType">Distribution:</label>
            <md-select
              name="distributionType"
              id="distributionType"
              v-model="block.distribution"
            >
              <md-option
                v-for="(params, distributionType) in distributions"
                :value="distributionType"
                @selected="block.params = {}"
              >{{ distributionType }}</md-option>
            </md-select>
          </md-input-container>
          <md-input-container
            v-if="block.distribution.length" 
            v-for="(paramOptions, param) in distributions[block.distribution]"
            md-clearable
          >
            <label>{{ param }}</label>
            <md-input
              v-model="block.params[param]"
            ></md-input>
          </md-input-container>
          <p style="font-size: 12px; color: 999;">
            In case of vectors you can get index as <b>_j</b><br>
            Dimension-wise indexes for tensors are <b>_j0, _j1, ...</b><br>
            Values stored in <b>_v</b>
          </p>
        </md-whiteframe>
        <!--
        <md-card-expand>
          <md-card-actions>
            <span style="flex: 1"></span>
            <md-button class="md-icon-button" md-expand-trigger>
              <md-icon>help</md-icon>
            </md-button>
          </md-card-actions>

          <md-card-content>
            Lorem ipsum dolor sit amet, consectetur adipisicing elit. Optio itaque ea, nostrum odio. Dolores, sed accusantium quasi non, voluptas eius illo quas, saepe voluptate pariatur in deleniti minus sint. Excepturi.
          </md-card-content>
        </md-card-expand>
        -->
        <!-- <pre>{{ block }}</pre> -->
      </md-card-content>

      <!-- Condition -->
      <md-card-content v-if="block.typeCode === 5">
        <md-input-container>
          <label>Proposition expression (boolean)</label>
          <md-input
            v-model="block.value"
          ></md-input>
        </md-input-container>
      </md-card-content>
    </md-card>

    <!-- Model output -->
    <div class="block">
      <h3 v-if="blocks.length > 0" style="margin: 35px 0 0 0">Model output:</h3>
      <md-checkbox v-for="block in blocks" v-if="block.hasOwnProperty('show')" v-model="block.show" class="md-primary" style="width: 100%; margin: 10px 0 5px 0;">
        <strong>{{ block.name }}</strong> ({{ block.type }})
      </md-checkbox>
    </div>

    <!-- Empty model button -->
    <md-boards v-if="!blocks.reduce((a, b) => b.show || a, false)":md-controls="true" :md-infinite="true" :md-swipeable="true" style="height: auto !important; margin-bottom: 10px;">
      <md-board id="slide1">
        <p><b><span style="border: 1px solid #5db53b; background-color: #5db53b; color: white; padding: 3px 4px;">&nbsp;Add blocks&nbsp;</span> to your model.</b> After you open StatSim or create a new model, add some elements (blocks) to it. There are multiple types of blocks. Data blocks can be constants or input parameters, expressions set relationships between elements, random variables describe stochastic values.</p>
      </md-board>
      <md-board id="slide2">
        <p><b>Update block settings.</b> Each block has its own settings. They determine how the program evaluates a block and its future usage. Almost each block has the <i>Show in results</i> checkbox. It determines if the block is shown in the output.</p>
      </md-board>
      <md-board id="slide3">
        <p><b>Set simulation <span style="border: 1px solid #e91e63; background-color: #e91e63; color: white; padding: 3px 4px;">Params</span>.</b> After you created and set all the blocks it's time to choose a simulation method. The simple rule is if you don't use random variables select <i>Deterministic</i>. For simulations choose <i>Rejection Sampling</i> or <i>MCMC</i>, for ML select <i>Optimization</i>. </p>
      </md-board>
      <md-board id="slide4">
        <p><b><span style="border: 1px solid #3f51b5; background-color: #3f51b5; color: white; padding: 3px 4px;">&nbsp;Run&nbsp;</span> your model</b> after saving it. If you don't use a server for simulations StatSim may become unresponsive and you may lose your data. In case everything went right you get some informative charts or scalar values as a result. Compile your model to binaries if you want to use it as a separate app.</p>
      </md-board>
    </md-boards>


    <div class="stat-seal" style="text-align: center;">
    <img src="images/s.png" style="width: 90px; height: auto; opacity: 0.35; margin: 15px 0px"></img>
    </div>
    <!-- Model control -->
    <md-button v-on:click.native="duplicateModel()">
      <md-icon>flip_to_front</md-icon>
      Duplicate
    </md-button>
    <md-button v-on:click.native="openDialog('remove-dialog')" :disabled="(models.length <= 1)" class="md-accent">
      <md-icon>delete_outlined</md-icon>
      Remove
    </md-button>
  </div>

  <!-- CONTENT -->
  <div class="content">
    <md-toolbar :class="'message-bar md-dense' + (error.length ? ' md-accent' : ' md-transparent')">
      <h3 class="message" style="flex: 1">
        {{ (error.length) ? (error.includes('Error') ? error : 'Error: ' + error) : '' }}
        {{ (message.length && !error.length) ? message : '' }}
      </h3>
      <md-button disabled class="desktop">Generate: </md-button>
      <md-button class="desktop editor-only" v-on:click.native="generateWebPPL">
        WPPL
      </md-button>
      <md-button class="desktop editor-only" v-on:click.native="generateJSON">
        JSON
      </md-button>
      <md-button v-on:click.native="generateLink">
        Link
      </md-button>
      <md-button
        class="md-icon-button editor-only"
        v-if="!showDataTable"
        @click.native="showDataTable = true; drawDataTable()"
      >
        <md-icon>grid_on</md-icon>
      </md-button>
      <md-button
        class="md-icon-button editor-only"
        v-if="showDataTable"
        @click.native="showDataTable = false"
      >
        <md-icon>grid_off</md-icon>
      </md-button>

      <md-button class="md-icon-button editor-only" @click="toggleRightSidenav">
        <md-icon>tune</md-icon>
      </md-button>

    </md-toolbar>

    <!-- Data table -->
    <div class="tables wl" v-if="showDataTable">
      <div class="control-buttons">
        <div style="float: left">
          <md-switch v-model="reactiveDataTable" name="reactive-table" class="md-primary">Reactive updates</md-switch>
        </div>
        <md-button class="md-dense" @click.native="updateData" :disabled="reactiveDataTable">
          <md-icon>check</md-icon>
          Save changes
        </md-button>
        <md-button class="md-dense" @click.native="drawDataTable" :disabled="reactiveDataTable">
          <md-icon>refresh</md-icon>
          Reload
        </md-button>
        <md-button class="md-dense" @click.native="showDataTable = false">
          <md-icon>close</md-icon>
          Close
        </md-button>
      </div>
      <div class="table-wrapper"></div>
    </div>

    <!-- Generated links and code -->
    <div class="links" v-if="link.length">
      <div class="control-buttons">
        <md-button class="md-dense" @click="link = ''">
          <md-icon>close</md-icon>
          Close
        </md-button>
      </div>
      <pre id="link" class="wl">{{ link }}</pre>
    </div>

    <!-- Needed for graph -->
    <svg style="position: absolute; top: -1000px;">
      <defs>
        <marker id="m-end" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth" >
          <path d="M0,0 L0,6 L9,3 z"></path>
        </marker>
      </defs>
    </svg>
    <div style="position: relative" class="graph-container">
      <div class="wl">
        <d3-network
          class="net"
          :net-nodes="graphNodes"
          :net-links="graphLinks"
          :options="graphOptions"
          :link-cb="lcb"
          v-on:node-click="ncb"
          v-if="graphNodes.length"
        ></d3-network>
        <div class="parameters" v-if="blocks.length || (models.length > 1)">
          <div class="chips">
            <md-chip v-for="b in blocks" :style="{background: colors[b.typeCode]}">{{ b.name || b.type }}</md-chip>
          </div>
          <p style="font-size:11px;">Model:</p>
          <h2>{{ modelParams.name }}</h2>
          <p class="model-description">{{ modelParams.description }}</p>
          <md-input-container v-for="b in blocks" v-if="b.typeCode === 2 && b.useAsParameter">
            <label>{{ b.name + ((b.units && b.units.length) ? ', ' + b.units : '') }}</label>
            <md-input v-model="b.value"></md-input>
          </md-input-container>
        </div>
      </div>
    </div>
    <div class="charts wl"></div>
    <div class="charts-2d wl"></div>
    <div class="charts-extra wl"></div>
    <div class="archives wl"></div>
  </div>

  <!-- PARAMETERS BAR -->
  <md-sidenav class="param-bar md-right editor-only" ref="rightSidenav">
    <md-toolbar class="md-dense">
      <div class="md-toolbar-container">
        <h3 class="md-title" style="flex: 1">Simulation parameters</h3>
        <md-button class="md-icon-button" @click="closeRightSidenav">
          <md-icon>close</md-icon>
        </md-button>
      </div>
    </md-toolbar>
    <div style="padding: 10px">

      <!-- Simulation method -->
      <md-input-container class="simulation-method-container">
        <label for="simulation-method">Simulation method:</label>
        <md-select name="simulation-method" id="simulation-method" v-model="modelParams.method">
          <md-option
            v-for="(methodObj, method) in simulationMethods" 
            :value="method">{{ methodObj.name }}</md-option>
        </md-select>
      </md-input-container>

      <!-- Time steps-->
      <md-input-container class="simulation-param">
        <label for="time-steps">Iterations:</label>
        <md-input
          name="time-steps"
          type="number"
          min="1"
          step="1"
          v-model="modelParams.steps"
        >
        </md-input>
      </md-input-container>

      <!-- Number of chains -->
      <md-input-container
        v-if="(modelParams.method !== 'deterministic')"
      >
        <label>Number of chains/workers</label>
        <md-input
          type="number"
          step="1"
          v-model="methodParams.chains"
        ></md-input>
      </md-input-container>


      <!-- Method parameters -->
      <div
        class="method-param"
        v-for="(paramOptions, param) in simulationMethods[modelParams.method].params"
      >

      <!-- Boolean -->
      <md-checkbox 
        :name="param"
        v-model="methodParams[param]"
        v-if="paramOptions.type === 'boolean'"
        class="md-primary"
      >{{ param }}</md-checkbox>

      <!-- Select / Number-->
      <md-input-container v-else>
          <label :for="param">{{ param }}</label>
          <md-input
            v-if="(paramOptions.type === 'int') || (paramOptions.type === 'real')"
            type="number"
            :step="(paramOptions.type === 'int') ? 1 : 0.001"
            v-model="methodParams[param]"
          ></md-input>
          <md-select
            :name="param"
            v-if="paramOptions.type === 'select'"
            v-model="methodParams[param]"
          >
            <md-option
              v-for="paramSelectValue in paramOptions.values"
              :value="paramSelectValue"
            >{{ paramSelectValue}}</md-option>
          </md-select>
        </md-input-container>

      </div>

      <md-checkbox 
        name="server"
        v-model="server"
        class="md-primary"
      >Server-side simulation</md-checkbox>

      <md-checkbox 
        name="server"
        v-model="serverCompile"
        class="md-primary"
        :disabled="!server"
      >Compile to binaries</md-checkbox>

      <!-- Server URL -->
      <md-input-container class="simulation-param">
        <label for="serverURL">URL</label>
        <md-input
          name="serverUrl"
          v-model="serverURL"
          :disabled="!server"
        >
        </md-input>
      </md-input-container>

      <!-- Server API -->
      <md-input-container class="simulation-param">
        <label for="serverAPI">API Key</label>
        <md-input
          name="serverAPI"
          v-model="serverAPI"
          :disabled="!server"
        >
        </md-input>
      </md-input-container>
      <!--
      <md-button class="md-raised md-primary" v-on:click.native="run()"><span class="desktop">Compile & </span>Run</md-button>
      -->
    </div>
  </md-sidenav>

  <!-- BOTTOM BAR-->
  <md-progress class="progress" v-if="loading" md-indeterminate></md-progress>
  <md-bottom-bar class="bottom-bar">
    <!-- Time steps-->
    <md-input-container class="simulation-param desktop">
      <label for="time-steps">Iterations</label>
      <md-input
        name="time-steps"
        type="number"
        min="1"
        step="1"
        v-model="modelParams.steps"
      >
      </md-input>
    </md-input-container>

    <!-- Simulation method -->
    <md-input-container class="simulation-method-container simulation-param desktop editor-only">
      <label for="simulation-method">Simulation method</label>
      <md-select name="simulation-method" id="simulation-method" v-model="modelParams.method">
        <md-option
          v-for="(methodObj, method) in simulationMethods" 
          :value="method">{{ methodObj.name }}</md-option>
      </md-select>
    </md-input-container>

    <div class="model-summary mobile">
      <p>Method: {{ modelParams.method }}</p>
      <p>Time steps: {{ modelParams.steps }}</p>
      <p v-if="(['MCMC','rejection', 'HMC'].indexOf(modelParams.method) >= 0) && methodParams.samples">Samples: {{ methodParams.samples }}</p>
    </div>
    <md-button class="md-raised md-accent params-button editor-only" @click="toggleRightSidenav">
      <md-icon>tune</md-icon>
      <span class="desktop">Params</span>
    </md-button>
    <md-button class="run-button md-raised md-primary" :disabled="blocks.length < 1" v-on:click.native="run()">
      <md-icon>play_arrow</md-icon>
      <span class="desktop editor-only">Compile & </span>Run
    </md-button>
  </md-bottom-bar>
  <div id="loader" class="hidden"><span><md-icon>hourglass_empty</md-icon> Processing..</span></div>
</div>
