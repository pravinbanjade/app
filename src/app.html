<div>
  <md-toolbar class="tool-bar md-dense">
    <p class="logo-icon">{{ icon }}</p>
    <h2 class="md-title logo" style="flex: 1"> StatSim <sup class="version">0.1.1</sup></h2>
    <md-menu md-size="4">
      <md-button class="md-raised md-primary" md-menu-trigger>
        + Add element
      </md-button>
      <md-menu-content>
        <md-menu-item v-on:click.native="addBlock(0)">
          <md-icon>graphic_eq</md-icon>
          <span>Random Variable</span>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(1)">
          <md-icon>functions</md-icon>
          <span>Expression</span>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(2)">
          <md-icon>view_headline</md-icon>
          <span>Data</span>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(3)">
          <md-icon>exposure_plus_1</md-icon>
          <span>Accumulator</span>
        </md-menu-item>
        <md-menu-item v-on:click.native="addBlock(4)">
          <md-icon>visibility</md-icon>
          <span>Observer</span>
        </md-menu-item>
      </md-menu-content>
    </md-menu>
  </md-toolbar>
  <div id="side-bar" class="side-bar">
    <!-- BLOCKS -->
    <md-card 
      v-for="(block, blockIndex) in blocks"
      :id="'block-id-' + blockIndex"
      :class="'block block-' + block.typeCode"
    >
      <!-- Block actions bar-->
      <md-card-actions :class="'block-header-' + block.typeCode">
        <div class="block-name"><strong>{{ block.name }}</strong> <span style="color: #777">{{ block.type }}</span></div>
        <md-button class="md-icon-button" v-on:click.native="moveBlockToTop(blockIndex)">
          <md-icon>keyboard_capslock</md-icon>
        </md-button>
        <md-button class="md-icon-button" v-on:click.native="moveBlockUp(blockIndex)">
          <md-icon>expand_less</md-icon>
        </md-button>
        <md-button class="md-icon-button" v-on:click.native="moveBlockDown(blockIndex)">
          <md-icon>expand_more</md-icon>
        </md-button>
        <md-button class="md-icon-button" v-on:click.native="removeBlock(blockIndex)">
          <md-icon>close</md-icon>
        </md-button>
      </md-card-actions>

      <!-- Random Variable -->
      <md-card-content v-if="block.typeCode === 0">
        <md-input-container>
          <label>Name</label>
          <md-input
            v-model="block.name"
          ></md-input>
        </md-input-container>
        <md-input-container>
          <label for="distributionType">Distribution type:</label>
          <md-select name="distributionType" id="distributionType" v-model="block.distribution">
            <md-option v-for="(params, distributionType) in distributions" :value="distributionType">{{ distributionType }}</md-option>
          </md-select>
        </md-input-container>
        <md-input-container
          v-if="block.distribution.length" 
          v-for="(paramOptions, param) in distributions[block.distribution]"
          md-clearable
        >
          <label>{{ param }}</label>
          <md-input
            v-model="block.params[param]"
          ></md-input>
        </md-input-container>
        <!-- Sample once per cycle-->
        <md-checkbox
          v-model="block.once"
          :disabled="steps < 1.5"
          class="md-primary"
        >
          Sampled once
        </md-checkbox>
        <md-checkbox
          :disabled="(steps > 1.5) && !block.once"
          v-model="block.show"
          class="md-primary"
        >
          Show in results
        </md-checkbox>
      </md-card-content>

      <!-- Expression -->
      <md-card-content v-if="block.typeCode === 1">
        <md-input-container>
          <label>Name</label>
          <md-input
            v-model="block.name"
          ></md-input>
        </md-input-container>
        <md-input-container>
          <label>Value</label>
          <md-input
            v-model="block.value"
          ></md-input>
        </md-input-container>
        <md-checkbox
          v-model="block.show"
          class="md-primary"
        >
          Show in results
        </md-checkbox>
      </md-card-content>

      <!-- Data -->
      <md-card-content v-if="block.typeCode === 2">
        <md-input-container>
          <label>Name</label>
          <md-input
            v-model="block.name"
          ></md-input>
        </md-input-container>
        <md-input-container>
          <label>Comma-separated values</label>
          <md-textarea v-model="block.value" height="5"></md-textarea>
        </md-input-container>
        <md-input-container>
          <label>Load from file</label>
          <md-file @change.native="loadFiles($event.target.files, blockIndex)"></md-file>
        </md-input-container>
        <md-checkbox
          v-model="block.show"
          class="md-primary"
        >
          Show in results
        </md-checkbox>
      </md-card-content>

      <!-- Accumulator -->
      <md-card-content v-if="block.typeCode === 3">
        <md-input-container>
          <label>Name</label>
          <md-input
            v-model="block.name"
          ></md-input>
        </md-input-container>
        <md-input-container>
          <label>Change value/expression</label>
          <md-input
            v-model="block.value"
          ></md-input>
        </md-input-container>
        <md-input-container>
          <label>Initial value</label>
          <md-input
            v-model="block.initialValue"
          ></md-input>
        </md-input-container>

        <md-checkbox v-model="block.show" class="md-primary">
          Show in results
        </md-checkbox>
        <md-checkbox 
          v-model="block.history"
          class="md-primary"
          :disabled="steps < 1.5"
        >
          Track history
        </md-checkbox>

      </md-card-content>

      <!-- Observer -->
      <md-card-content v-if="block.typeCode === 4">
        <md-input-container>
          <label for="distributionType">Distribution:</label>
          <md-select name="distributionType" id="distributionType" v-model="block.distribution">
            <md-option v-for="(params, distributionType) in distributions" :value="distributionType">{{ distributionType }}</md-option>
          </md-select>
        </md-input-container>
        <md-input-container
          v-if="block.distribution.length" 
          v-for="(paramOptions, param) in distributions[block.distribution]"
          md-clearable
        >
          <label>{{ param }}</label>
          <md-input
            v-model="block.params[param]"
          ></md-input>
        </md-input-container>
        <md-input-container>
          <label>Observed value(s)</label>
          <md-input
            v-model="block.value"
          ></md-input>
        </md-input-container>
      </md-card-content>


    </md-card>
  </div>

  <!-- CONTENT -->
  <div class="content">
    <md-toolbar :class="'message-bar md-dense' + (error.length ? ' md-accent' : ' md-transparent')">
      <h3 style="flex: 1">{{ (error.length) ? 'Error: ' + error : ''}}</h3>
      <md-button disabled class="desktop">Generate: </md-button>
      <md-button v-on:click.native="generateWebPPL">
        WPPL
      </md-button>
      <md-button class="desktop" v-on:click.native="generateJSON">
        JSON
      </md-button>
      <md-button v-on:click.native="generateLink">
        Link
      </md-button>
      <md-button class="md-icon-button" @click="toggleRightSidenav">
        <md-icon>tune</md-icon>
      </md-button>

    </md-toolbar>
    <pre id="link" v-if="link.length">{{ link }}</pre>
    <svg style="position: absolute">
      <defs>
        <marker id="m-end" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth" >
          <path d="M0,0 L0,6 L9,3 z"></path>
        </marker>
      </defs>
    </svg>
    <d3-network
      :net-nodes="graphNodes"
      :net-links="graphLinks"
      :options="graphOptions"
      :link-cb="lcb"
      v-on:node-click="ncb"
      v-if="graphNodes.length"
    ></d3-network>
    <div class="charts"></div>
  </div>

  <!-- PARAMETERS BAR -->
  <md-sidenav class="param-bar md-right" ref="rightSidenav">
    <md-toolbar class="md-dense">
      <div class="md-toolbar-container">
        <h3 class="md-title" style="flex: 1">Simulation parameters</h3>
        <md-button class="md-icon-button" @click="closeRightSidenav">
          <md-icon>close</md-icon>
        </md-button>
      </div>
    </md-toolbar>
    <div style="padding: 10px">

      <!-- Simulation method -->
      <md-input-container class="simulation-method-container">
        <label for="simulation-method">Simulation method:</label>
        <md-select name="simulation-method" id="simulation-method" v-model="method">
          <md-option
            v-for="(methodObj, method) in simulationMethods" 
            :value="method">{{ methodObj.name }}</md-option>
        </md-select>
      </md-input-container>

      <!-- Time steps-->
      <md-input-container class="simulation-param">
        <label for="time-steps">Time steps (intervals):</label>
        <md-input
          name="time-steps"
          type="number"
          min="1"
          step="1"
          v-model="steps"
        >
        </md-input>
      </md-input-container>

      <!-- Method parameters -->
      <div
        class="method-param"
        v-for="(paramOptions, param) in simulationMethods[method].params"
      >

      <!-- Boolean -->
      <md-checkbox 
        :name="param"
        v-model="methodParams[param]"
        v-if="paramOptions.type === 'boolean'"
        class="md-primary"
      >{{ param }}</md-checkbox>

      <!-- Select / Number-->
      <md-input-container v-else>
          <label :for="param">{{ param }}</label>
          <md-input
            v-if="(paramOptions.type === 'int') || (paramOptions.type === 'real')"
            type="number"
            v-model="methodParams[param]"
          ></md-input>
          <md-select
            :name="param"
            v-if="paramOptions.type === 'select'"
            v-model="methodParams[param]"
          >
            <md-option
              v-for="paramSelectValue in paramOptions.values"
              :value="paramSelectValue"
            >{{ paramSelectValue}}</md-option>
          </md-select>
        </md-input-container>

      </div>
      <!-- Run -->
      <md-button class="md-raised md-primary" v-on:click.native="run()"><span class="desktop">Compile & </span>Run</md-button>
    </div>
  </md-sidenav>

  <!-- BOTTOM BAR-->
  <md-progress class="progress" v-if="loading" md-indeterminate></md-progress>
  <md-bottom-bar class="bottom-bar">
    <!-- Time steps-->
    <md-input-container class="simulation-param desktop">
      <label for="time-steps">Time steps:</label>
      <md-input
        name="time-steps"
        type="number"
        min="1"
        step="1"
        v-model="steps"
      >
      </md-input>
    </md-input-container>

    <!-- Simulation method -->
    <md-input-container class="simulation-method-container simulation-param desktop">
      <label for="simulation-method">Simulation method:</label>
      <md-select name="simulation-method" id="simulation-method" v-model="method">
        <md-option
          v-for="(methodObj, method) in simulationMethods" 
          :value="method">{{ methodObj.name }}</md-option>
      </md-select>
    </md-input-container>

    <div class="summary mobile">
      <p>Method: {{ method }}</p>
      <p>Time steps: {{ steps }}</p>
      <p v-if="methodParams.samples">Samples: {{ methodParams.samples }}</p>
    </div>
    <md-button class="md-raised md-accent" @click="toggleRightSidenav">Params</md-button>
    <md-button class="md-raised md-primary" v-on:click.native="run()"><span class="desktop">Compile & </span>Run</md-button>
  </md-bottom-bar>
  <div id="loader" class="hidden"><span>Loading..</span></div>
</div>
